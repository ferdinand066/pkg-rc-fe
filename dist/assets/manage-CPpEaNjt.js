import{B as e,d as a,f as r,h as s,m as i,r as t,Q as n,i as o,k as d,x as l,b as m,j as c,t as u}from"./index-BMio7b_C.js";import{I as p}from"./InputSelect-BKT60kPV.js";import{u as g,I as b}from"./InputText-C-iQ4tFZ.js";import{I as h}from"./InputTextarea-_qbvJg5O.js";import{I as x}from"./InputToggle-BPG4zHPL.js";import{A as j}from"./AlertContainer-CgTVNv1s.js";import{P as f}from"./PageHeader-oQ2FRQ3y.js";import{a as w}from"./use-borrowed-room-DqH6f-pV.js";import{B as _,p as y,i as N,a as v}from"./borrowed-room-service-Dyfu059f.js";import{u as R,a as T}from"./use-room-CZ7BsnTR.js";import{A as E,I as C,B as k,c as q,b as A}from"./constants-5vXSpW5c.js";import{i as D}from"./isBefore-BU7b8VsE.js";import"./useQuery-8fHC9d-I.js";import"./startOfDay-Cqt31xqJ.js";import"./isValid-5aXsojdQ.js";const I="https://booking-api.parokipik.org/admin/borrowed-room";class B extends e{static async acceptBorrowedRoom(e,a){if(e)try{return await this._post(`${I}/${e}/accept`,a)}catch(r){throw new Error(r.message)}}static async declineBorrowedRoom(e){if(e)try{return await this._post(`${I}/${e}/decline`,{})}catch(a){throw new Error(a.message)}}}const P=[{text:"menolak",style:"text-error"},{text:"menyetujui",style:"text-success"}],V=["badge-error","badge-warning","badge-success"],$=e=>{if(!e)return[];const a=(e?.borrowed_room_agreements??[]).map((e=>({message:c.jsxs("span",{children:[e.created_by.name," telah"," ",c.jsx("span",{className:P[e.agreement_status].style,children:P[e.agreement_status].text})," ","permintaan ini."]})})));if(0===(e.pending_users??[]).length)return a;const r={message:c.jsxs("span",{children:[c.jsx("span",{className:"text-warning",children:"Menunggu konfirmasi"})," dari"," ",e.pending_users?.map((e=>e.name)).join(", ")]})};return[...a,r]},K=()=>{const{id:e}=l(),{data:E,status:I}=w(e??""),{data:P,status:K}=R({},{order_by:"name",data_order:"asc"},!1),{register:S,setValue:L,errors:M,handleManageBorrowedRoom:F,handleDeleteBorrowedRoom:J,handleAcceptBorrowedRoom:Q,handleDeclineBorrowedRoom:U,handleSubmit:H,watch:W,getValues:G,formState:z}=((e=null)=>{const{register:l,setValue:m,getValues:c,formState:{errors:u},handleSubmit:p,watch:b,reset:h,formState:x}=g(),[j,f]=a(r),w=s(),y=i(),{data:N}=R({},{order_by:"name",data_order:"asc"},!1);return t.useEffect((()=>{if(h(),e){if(Object.keys(e).filter((e=>!["room_items","item_id"].includes(e))).forEach((a=>{m(a,e[a])})),!N)return;e.borrowed_room_items?.map((e=>{const a=b("room_id"),r=N.find((e=>e.id===a)),s=r?.room_items?.map((e=>e.item_id)),i=(s??[]).indexOf(e.item_id);void 0!==i&&(i<0||(m(`items.${i}.item_id`,e.item_id),m(`items.${i}.quantity`,e.quantity)))}))}}),[e,m,N]),{register:l,setValue:m,errors:u,handleManageBorrowedRoom:async function(a){if(!j){a={...a,items:a.items.filter((e=>!!e.item_id))},f(!0);try{e?await n.promise(_.updateBorrowedRoom(e.id,a),{pending:"Waiting for update borrowed room!",error:d(),success:o()}):await n.promise(_.createBorrowedRoom(a),{pending:"Waiting for create borrowed room!",error:d(),success:o()})}catch(r){}w.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&w.invalidateQueries({queryKey:["general/borrowed-room",e.id]}),f(!1)}},handleDeleteBorrowedRoom:async function(){if(e&&!j){f(!0);try{await n.promise(_.deleteBorrowedRoom(e.id),{pending:"Waiting for delete borrowed room!",error:d(),success:o()})}catch(a){}f(!1),h(),w.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&w.invalidateQueries({queryKey:["general/borrowed-room",e.id]}),y("/room-request")}},handleAcceptBorrowedRoom:async function(){if(!e)return;if(j)return;const a=c("start_borrowing_time");f(!0);try{await n.promise(B.acceptBorrowedRoom(e.id,{start_borrowing_time:a}),{pending:"Waiting for accept borrowed room!",error:d(),success:o()})}catch(r){}f(!1),w.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e?w.invalidateQueries({queryKey:["general/borrowed-room",e.id]}):y("/room-request")},handleDeclineBorrowedRoom:async function(){if(e&&!j){f(!0);try{await n.promise(B.declineBorrowedRoom(e.id),{pending:"Waiting for decline borrowed room!",error:d(),success:o()})}catch(a){}f(!1),w.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&w.invalidateQueries({queryKey:["general/borrowed-room",e.id]})}},handleSubmit:p,watch:b,getValues:c,formState:x}})(E),X=W("room_id"),Y=W("borrowed_date"),[Z,ee]=t.useState(!1),[ae,re]=t.useState(!1),{user:se}=m(),ie=((e,a,r,s)=>{if(!a)return"CREATE";if(!r)return"LOADING";if("pending"===e)return"LOADING";if("error"===e)return"ERROR";if(!s)return"CREATE";if(s.borrowed_by_user_id===r.id)return s.borrowed_status===k?s.borrowed_room_agreements.length>0?"CONFIRMED":"UPDATE":s.borrowed_status===q?"CONFIRMED":"UPDATE";const i=s.pending_users??[];return 0===i.length?"UPDATE":s.borrowed_status===k?i.filter((e=>e.id===r.id)).length>0?"CONFIRMATION":"UPDATE":"CONFIRMED"})(I,e,se,E),te=["CREATE","UPDATE"].includes(ie);const ne=(e=>["CONFIRMATION"].includes(e))(ie);t.useEffect((()=>{if("success"!==K)return;if(Z)return;if(E)return;ee(!0);L("room_id",P[0].id)}),[Z,K]),t.useEffect((()=>{e&&E&&se&&(2!==E.borrowed_status||se.role)}),[se,E]);const{data:oe,status:de}=T(X,{borrowing_date:Y,borrowed_room_id:e,check_schedule:z.isDirty});return c.jsxs("section",{className:"flex flex-col h-full flex-1 gap-4 mb-8 divide-y",children:[c.jsxs("div",{className:"flex flex-col",children:[c.jsx(f,{pageName:(e?"":"Buat ")+"Proposal Pinjam Ruang",action:"pending"===I&&e?c.jsx("span",{className:"loading loading-dots loading-xs"}):E&&null!==E?.borrowed_status?c.jsx("div",{className:u("badge badge-outline px-4 py-3",V[E?.borrowed_status]),children:A[E?.borrowed_status]}):c.jsx(c.Fragment,{})}),c.jsx(j,{notification:$(E)}),c.jsxs("form",{onSubmit:H(F),className:"grid grid-cols-6 gap-4 mx-6",children:[c.jsx("div",{className:"col-span-6 sm:col-span-5",children:c.jsx(b,{label:"Nama Kegiatan",type:"text",name:"event_name",placeholder:"Contoh: Acara Natal",disabled:!te,register:S("event_name",{required:"Nama kegiatan harus diisi"}),setValue:L,errors:M,isLoading:"pending"===I&&!!e})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{label:"Nama PIC",type:"text",name:"pic_name",placeholder:"Tuliskan nama anda",disabled:!te,register:S("pic_name",{required:"Nama PIC harus diisi"}),setValue:L,errors:M,isLoading:"pending"===I&&!!e})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{label:"No. Telp PIC",type:"text",name:"pic_phone_number",placeholder:"Format: 08.....",disabled:!te,register:S("pic_phone_number",{required:"No. Telp PIC harus diisi"}),setValue:L,errors:M,isLoading:"pending"===I&&!!e})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{label:"Tanggal Pinjam Ruangan",type:"date",name:"borrowed_date",disabled:!te,register:S("borrowed_date",{required:"Tanggal peminjaman harus diisi",validate:e=>{const a=y(e),r=new Date;return!(!N(a,r)&&!v(a,r))||"Tanggal peminjaman harus setelah hari ini"}}),setValue:L,errors:M,isLoading:"pending"===I&&!!e})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{disabled:!te,label:"Kapasitas",type:"number",name:"capacity",register:S("capacity",{required:"Kapasitas harus diisi"}),setValue:L,errors:M,isLoading:"pending"===I&&!!e})}),c.jsx("div",{className:"col-span-6 sm:col-span-4",children:c.jsx(p,{disabled:!te,label:"Ruangan",name:"room_id",register:S("room_id",{required:"Ruangan harus diisi"}),setValue:L,model:(P??[]).map((e=>({id:e.id,name:e.name+" ("+e.floor.name+")"})))??[],errors:M,description:"success"===de?c.jsxs("div",{className:"flex flex-col text-sm mt-2",children:[c.jsx("span",{children:"Tersedia pada"}),c.jsx("ul",{children:(oe??[]).map(((e,a)=>c.jsxs("li",{className:"ml-2",children:["âœ“ ",e]},a)))})]}):c.jsx(c.Fragment,{}),isLoading:"pending"===K})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{disabled:!te,label:"Jam Mulai Pinjam",type:"time",step:C,name:"start_borrowing_time",register:S("start_borrowing_time",{required:"Jam mulai pinjam harus diisi"}),setValue:L,errors:M,isLoading:"pending"===I&&!!e})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{disabled:!te,label:"Jam Mulai Acara",type:"time",step:C,name:"start_event_time",register:S("start_event_time",{required:"Jam mulai acara harus diisi",validate:e=>{const a=G("start_borrowing_time"),r=new Date(`2000-01-01T${a}`);if(D(new Date(`2000-01-01T${e}`),r))return"Jam mulai harus setelah jam mulai pinjam"}}),setValue:L,errors:M,isLoading:"pending"===I&&!!e})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{disabled:!te,label:"Jam Selesai Pinjam",type:"time",step:C,name:"end_event_time",register:S("end_event_time",{required:"Jam akhir harus diisi",validate:e=>{const a=G("start_event_time"),r=new Date(`2000-01-01T${a}`);if(!N(new Date(`2000-01-01T${e}`),r))return"Jam akhir event harus setelah jam mulai event"}}),setValue:L,errors:M,isLoading:"pending"===I&&!!e})}),c.jsx("div",{className:"col-span-6 sm:col-span-4",children:"pending"===K?c.jsx(O,{}):X&&P&&P.find((e=>e.id===X))?.room_items?.map(((e,a)=>{const r=W(`items.${a}.item_id`);return c.jsxs("div",{className:"grid grid-cols-3 items-center",children:[c.jsx(x,{disabled:!te,label:e.item.name,name:`items.${a}.item_id`,id:`items.${a}.item_id`,value:e.item_id,register:S(`items.${a}.item_id`),inputContainerClassName:"col-span-2",errors:M}),!!r&&c.jsx(b,{type:"number",disabled:!te,inputClassName:"input-sm",placeholder:"Jumlah barang",min:1,name:`items.${a}.quantity`,id:`items.${a}.quantity`,register:S(`items.${a}.quantity`,{required:"Harus diisi"}),setValue:L,errors:M})]},e.id)}))}),c.jsx("div",{className:"col-span-6",children:c.jsx(h,{disabled:!te,label:"Keterangan",name:"description",id:"description",register:S("description",{required:"Keterangan harus diisi"}),setValue:L,errors:M})}),["UPDATE","CREATE","CONFIRMED"].includes(ie)&&c.jsxs("div",{className:"col-span-6 modal-action flex-row-reverse justify-between",children:[c.jsxs("div",{className:"flex flex-row gap-4",children:[c.jsx("button",{className:"btn btn-neutral",type:"button",children:"Tutup"}),["UPDATE","CREATE"].includes(ie)&&c.jsx("button",{className:"btn btn-primary",type:"submit",children:E?"Ubah":"Buat"})]}),E&&c.jsx("button",{className:"btn !ml-0 btn-error",type:"button",onClick:()=>re(!0),children:"Hapus"})]}),ne&&c.jsxs("div",{className:"col-span-6 modal-action flex-row-reverse justify-between",children:[c.jsx("button",{className:"btn btn-primary",onClick:H((async()=>await Q())),children:"Setujui"}),c.jsx("button",{className:"btn !ml-0 btn-error",type:"button",onClick:async()=>{await U()},children:"Tolak"})]})]})]}),c.jsxs("dialog",{id:"delete_modal",className:"modal "+(ae?"modal-open":""),children:[c.jsxs("div",{className:"modal-box",children:[c.jsx("h3",{className:"font-bold text-lg",children:"Konfirmasi Hapus"}),c.jsx("p",{className:"py-4",children:"Apakah Anda yakin ingin menghapus proposal pinjam ruang ini? Tindakan ini tidak dapat dibatalkan."}),c.jsxs("div",{className:"modal-action",children:[c.jsx("button",{className:"btn btn-neutral",onClick:()=>re(!1),children:"Batal"}),c.jsx("button",{className:"btn btn-error",onClick:()=>{J(),re(!1)},children:"Hapus"})]})]}),c.jsx("form",{method:"dialog",className:"modal-backdrop",children:c.jsx("button",{onClick:()=>re(!1),children:"close"})})]})]})},O=()=>c.jsxs("div",{className:"flex flex-row gap-4 px-1 items-center",children:[c.jsx("div",{className:"bg-base-300 min-w-12 animate-pulse rounded-full h-7"}),c.jsx("div",{className:"bg-base-300 min-w-32 animate-pulse rounded-full h-6"})]});export{K as default};
