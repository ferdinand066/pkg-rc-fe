import{B as e,u as a,f as s,a as r,d as i,r as t,Q as n,h as o,b as d,w as l,n as m,q as c,j as u,I as p,p as g,z as b,y as h,o as x}from"./index-DpP_SUQ6.js";import{I as j}from"./input-select-BvffwCdU.js";import{u as f,I as _}from"./input-text-Ds8sWXwC.js";import{I as w}from"./input-textarea-B0h35171.js";import{i as y,I as N}from"./input-toggle-DpJsb5h-.js";import{A as v}from"./alert-container-54q1FS93.js";import{P as R}from"./page-header-xlds1YNX.js";import{a as q}from"./use-borrowed-room-Crp_CgRo.js";import{B as T,p as E,i as C,a as D}from"./borrowed-room-service-DlN0d7Sv.js";import{u as k,a as A}from"./use-room-Ckk35-Rt.js";import"./isValid-5aXsojdQ.js";import"./useQuery-C6faGm9h.js";import"./startOfDay-Cqt31xqJ.js";const B="https://booking-api.parokipik.org/admin/borrowed-room";class I extends e{static async acceptBorrowedRoom(e,a){if(e)return await this._post(`${B}/${e}/accept`,a)}static async declineBorrowedRoom(e){if(e)return await this._post(`${B}/${e}/decline`,{})}}const V=[{text:"menolak",style:"text-error"},{text:"menyetujui",style:"text-success"}],P=["badge-error","badge-warning","badge-success"],$=e=>{if(!e)return[];const a=(e?.borrowed_room_agreements??[]).map((e=>({message:u.jsxs("span",{children:[e.created_by.name," telah"," ",u.jsx("span",{className:V[e.agreement_status].style,children:V[e.agreement_status].text})," ","permintaan ini."]})})));if(0===(e.pending_users??[]).length)return a;const s={message:u.jsxs("span",{children:[u.jsx("span",{className:"text-warning",children:"Menunggu konfirmasi"})," dari"," ",e.pending_users?.map((e=>e.name)).join(", ")]})};return[...a,s]},K=()=>{const{id:e}=l(),{data:c,status:B}=q(e??""),{data:V,status:K}=k({},{order_by:"name",data_order:"asc"},!1),{register:S,setValue:L,errors:M,handleManageBorrowedRoom:F,handleDeleteBorrowedRoom:J,handleAcceptBorrowedRoom:Q,handleDeclineBorrowedRoom:U,handleSubmit:W,watch:H,getValues:G,formState:z}=((e=null)=>{const{register:l,setValue:m,getValues:c,formState:{errors:u},handleSubmit:p,watch:g,reset:b,formState:h}=f(),[x,j]=a(s),_=r(),w=i(),{data:y}=k({},{order_by:"name",data_order:"asc"},!1);return t.useEffect((()=>{if(b(),e){if(Object.keys(e).filter((e=>!["room_items","item_id"].includes(e))).forEach((a=>{m(a,e[a])})),!y)return;e.borrowed_room_items?.map((e=>{const a=g("room_id"),s=y.find((e=>e.id===a)),r=s?.room_items?.map((e=>e.item_id)),i=(r??[]).indexOf(e.item_id);void 0!==i&&(i<0||(m(`items.${i}.item_id`,e.item_id),m(`items.${i}.quantity`,e.quantity)))}))}}),[e,m,y]),{register:l,setValue:m,errors:u,handleManageBorrowedRoom:async function(a){x||(a={...a,items:a.items.filter((e=>!!e.item_id))},j(!0),e?await n.promise(T.updateBorrowedRoom(e.id,a),{pending:"Waiting for update borrowed room!",error:d(),success:o()}):await n.promise(T.createBorrowedRoom(a),{pending:"Waiting for create borrowed room!",error:d(),success:o()}),_.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&_.invalidateQueries({queryKey:["general/borrowed-room",e.id]}),j(!1))},handleDeleteBorrowedRoom:async function(){e&&(x||(j(!0),await n.promise(T.deleteBorrowedRoom(e.id),{pending:"Waiting for delete borrowed room!",error:d(),success:o()}),j(!1),b(),_.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&_.invalidateQueries({queryKey:["general/borrowed-room",e.id]}),w("/room-request")))},handleAcceptBorrowedRoom:async function(){if(!e)return;if(x)return;const a=c("start_borrowing_time");j(!0),await n.promise(I.acceptBorrowedRoom(e.id,{start_borrowing_time:a}),{pending:"Waiting for accept borrowed room!",error:d(),success:o()}),j(!1),_.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e?_.invalidateQueries({queryKey:["general/borrowed-room",e.id]}):w("/room-request")},handleDeclineBorrowedRoom:async function(){e&&(x||(j(!0),await n.promise(I.declineBorrowedRoom(e.id),{pending:"Waiting for decline borrowed room!",error:d(),success:o()}),j(!1),_.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&_.invalidateQueries({queryKey:["general/borrowed-room",e.id]})))},handleSubmit:p,watch:g,getValues:c,formState:h}})(c),X=H("room_id"),Y=H("borrowed_date"),[Z,ee]=t.useState(!1),[ae,se]=t.useState(!1),{user:re}=m(),ie=((e,a,s,r)=>{if(!a)return"CREATE";if(!s)return"LOADING";if("pending"===e)return"LOADING";if("error"===e)return"ERROR";if(!r)return"CREATE";if(r.borrowed_by_user_id===s.id)return r.borrowed_status===g?r.borrowed_room_agreements.length>0?"CONFIRMED":"UPDATE":r.borrowed_status===b?"CONFIRMED":"UPDATE";const i=r.pending_users??[];return 0===i.length?"UPDATE":r.borrowed_status===g?i.filter((e=>e.id===s.id)).length>0?"CONFIRMATION":"UPDATE":"CONFIRMED"})(B,e,re,c),te=["CREATE","UPDATE"].includes(ie);const ne=(e=>["CONFIRMATION"].includes(e))(ie);t.useEffect((()=>{if("success"!==K)return;if(Z)return;if(c)return;ee(!0);L("room_id",V[0].id)}),[Z,K,c,V,L]),t.useEffect((()=>{e&&c&&re&&(2!==c.borrowed_status||re.role)}),[re,c,e]);const{data:oe,status:de}=A(X,{borrowing_date:Y,borrowed_room_id:e,check_schedule:z.isDirty});return u.jsxs("section",{className:"flex flex-col h-full flex-1 gap-4 mb-8 divide-y",children:[u.jsxs("div",{className:"flex flex-col",children:[u.jsx(R,{pageName:(e?"":"Buat ")+"Proposal Pinjam Ruang",action:"pending"===B&&e?u.jsx("span",{className:"loading loading-dots loading-xs"}):c&&null!==c?.borrowed_status?u.jsx("div",{className:x("badge badge-outline px-4 py-3",P[c?.borrowed_status]),children:h[c?.borrowed_status]}):u.jsx(u.Fragment,{})}),u.jsx(v,{notification:$(c)}),u.jsxs("form",{onSubmit:W(F),className:"grid grid-cols-6 gap-4 mx-6",children:[u.jsx("div",{className:"col-span-6 sm:col-span-5",children:u.jsx(_,{label:"Nama Kegiatan",type:"text",name:"event_name",placeholder:"Contoh: Acara Natal",disabled:!te,register:S("event_name",{required:"Nama kegiatan harus diisi"}),setValue:L,errors:M,isLoading:"pending"===B&&!!e})}),u.jsx("div",{className:"col-span-6 sm:col-span-2",children:u.jsx(_,{label:"Nama PIC",type:"text",name:"pic_name",placeholder:"Tuliskan nama anda",disabled:!te,register:S("pic_name",{required:"Nama PIC harus diisi"}),setValue:L,errors:M,isLoading:"pending"===B&&!!e})}),u.jsx("div",{className:"col-span-6 sm:col-span-2",children:u.jsx(_,{label:"No. Telp PIC",type:"text",name:"pic_phone_number",placeholder:"Format: 08.....",disabled:!te,register:S("pic_phone_number",{required:"No. Telp PIC harus diisi"}),setValue:L,errors:M,isLoading:"pending"===B&&!!e})}),u.jsx("div",{className:"col-span-6 sm:col-span-2",children:u.jsx(_,{label:"Tanggal Pinjam Ruangan",type:"date",name:"borrowed_date",disabled:!te,register:S("borrowed_date",{required:"Tanggal peminjaman harus diisi",validate:e=>{const a=E(e),s=new Date;return!(!C(a,s)&&!D(a,s))||"Tanggal peminjaman harus setelah hari ini"}}),setValue:L,errors:M,isLoading:"pending"===B&&!!e})}),u.jsx("div",{className:"col-span-6 sm:col-span-2",children:u.jsx(_,{disabled:!te,label:"Kapasitas",type:"number",name:"capacity",register:S("capacity",{required:"Kapasitas harus diisi"}),setValue:L,errors:M,isLoading:"pending"===B&&!!e})}),u.jsx("div",{className:"col-span-6 sm:col-span-4",children:u.jsx(j,{disabled:!te,label:"Ruangan",name:"room_id",register:S("room_id",{required:"Ruangan harus diisi"}),setValue:L,model:(V??[]).map((e=>({id:e.id,name:e.name+" ("+e.floor.name+")"})))??[],errors:M,description:"success"===de?u.jsxs("div",{className:"flex flex-col text-sm mt-2",children:[u.jsx("span",{children:"Tersedia pada"}),u.jsx("ul",{children:(oe??[]).map(((e,a)=>u.jsxs("li",{className:"ml-2",children:["âœ“ ",e]},a)))})]}):u.jsx(u.Fragment,{}),isLoading:"pending"===K})}),u.jsx("div",{className:"col-span-6 sm:col-span-2",children:u.jsx(_,{disabled:!te,label:"Jam Mulai Pinjam",type:"time",step:p,name:"start_borrowing_time",register:S("start_borrowing_time",{required:"Jam mulai pinjam harus diisi"}),setValue:L,errors:M,isLoading:"pending"===B&&!!e})}),u.jsx("div",{className:"col-span-6 sm:col-span-2",children:u.jsx(_,{disabled:!te,label:"Jam Mulai Acara",type:"time",step:p,name:"start_event_time",register:S("start_event_time",{required:"Jam mulai acara harus diisi",validate:e=>{const a=G("start_borrowing_time"),s=new Date(`2000-01-01T${a}`);if(y(new Date(`2000-01-01T${e}`),s))return"Jam mulai harus setelah jam mulai pinjam"}}),setValue:L,errors:M,isLoading:"pending"===B&&!!e})}),u.jsx("div",{className:"col-span-6 sm:col-span-2",children:u.jsx(_,{disabled:!te,label:"Jam Selesai Pinjam",type:"time",step:p,name:"end_event_time",register:S("end_event_time",{required:"Jam akhir harus diisi",validate:e=>{const a=G("start_event_time"),s=new Date(`2000-01-01T${a}`);if(!C(new Date(`2000-01-01T${e}`),s))return"Jam akhir event harus setelah jam mulai event"}}),setValue:L,errors:M,isLoading:"pending"===B&&!!e})}),u.jsx("div",{className:"col-span-6 sm:col-span-4",children:"pending"===K?u.jsx(O,{}):X&&V&&V.find((e=>e.id===X))?.room_items?.map(((e,a)=>{const s=H(`items.${a}.item_id`);return u.jsxs("div",{className:"grid grid-cols-3 items-center",children:[u.jsx(N,{disabled:!te,label:e.item.name,name:`items.${a}.item_id`,id:`items.${a}.item_id`,value:e.item_id,register:S(`items.${a}.item_id`),inputContainerClassName:"col-span-2",errors:M}),!!s&&u.jsx(_,{type:"number",disabled:!te,inputClassName:"input-sm",placeholder:"Jumlah barang",min:1,name:`items.${a}.quantity`,id:`items.${a}.quantity`,register:S(`items.${a}.quantity`,{required:"Harus diisi"}),setValue:L,errors:M})]},e.id)}))}),u.jsx("div",{className:"col-span-6",children:u.jsx(w,{disabled:!te,label:"Keterangan",name:"description",id:"description",register:S("description",{required:"Keterangan harus diisi"}),setValue:L,errors:M})}),["UPDATE","CREATE","CONFIRMED"].includes(ie)&&u.jsxs("div",{className:"col-span-6 modal-action flex-row-reverse justify-between",children:[u.jsxs("div",{className:"flex flex-row gap-4",children:[u.jsx("button",{className:"btn btn-neutral",type:"button",children:"Tutup"}),["UPDATE","CREATE"].includes(ie)&&u.jsx("button",{className:"btn btn-primary",type:"submit",children:c?"Ubah":"Buat"})]}),c&&u.jsx("button",{className:"btn !ml-0 btn-error",type:"button",onClick:()=>se(!0),children:"Hapus"})]}),ne&&u.jsxs("div",{className:"col-span-6 modal-action flex-row-reverse justify-between",children:[u.jsx("button",{className:"btn btn-primary",onClick:W((async()=>await Q())),children:"Setujui"}),u.jsx("button",{className:"btn !ml-0 btn-error",type:"button",onClick:async()=>{await U()},children:"Tolak"})]})]})]}),u.jsxs("dialog",{id:"delete_modal",className:"modal "+(ae?"modal-open":""),children:[u.jsxs("div",{className:"modal-box",children:[u.jsx("h3",{className:"font-bold text-lg",children:"Konfirmasi Hapus"}),u.jsx("p",{className:"py-4",children:"Apakah Anda yakin ingin menghapus proposal pinjam ruang ini? Tindakan ini tidak dapat dibatalkan."}),u.jsxs("div",{className:"modal-action",children:[u.jsx("button",{className:"btn btn-neutral",onClick:()=>se(!1),children:"Batal"}),u.jsx("button",{className:"btn btn-error",onClick:()=>{J(),se(!1)},children:"Hapus"})]})]}),u.jsx("form",{method:"dialog",className:"modal-backdrop",children:u.jsx("button",{onClick:()=>se(!1),children:"close"})})]})]})},O=()=>u.jsxs("div",{className:"flex flex-row gap-4 px-1 items-center",children:[u.jsx("div",{className:"bg-base-300 min-w-12 animate-pulse rounded-full h-7"}),u.jsx("div",{className:"bg-base-300 min-w-32 animate-pulse rounded-full h-6"})]});export{K as default};
