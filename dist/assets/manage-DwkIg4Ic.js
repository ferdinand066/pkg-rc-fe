import{B as e,c as r,f as a,h as t,m as s,r as i,Q as n,i as o,k as l,x as d,a as m,j as u,t as c}from"./index-CoHiygy3.js";import{I as p}from"./InputSelect-wkVSoLyP.js";import{u as g,I as f}from"./InputText-Bd-nKs3U.js";import{I as h}from"./InputTextarea-DEI7mQrQ.js";import{I as b}from"./InputToggle-GF51Ct7s.js";import{A as w}from"./AlertContainer-8jbEjKht.js";import{P as x}from"./PageHeader-DDeztv-2.js";import{B as j,a as N}from"./use-borrowed-room-A5S3YGLx.js";import{u as _,a as y}from"./use-room-_WmYEM-v.js";import{A as v,I as T,B as D,c as C,b as R}from"./constants-5vXSpW5c.js";import{s as q,b as I,c as E}from"./startOfDay-Do9sk2vp.js";import{t as $}from"./isValid-5aXsojdQ.js";import"./useQuery-D4UjwIFn.js";function A(e,r){const a=$(e),t=$(r);return a.getTime()>t.getTime()}function B(e,r){const a=function(e){const r={},a=e.split(U.dateTimeDelimiter);let t;if(a.length>2)return r;/:/.test(a[0])?t=a[0]:(r.date=a[0],t=a[1],U.timeZoneDelimiter.test(r.date)&&(r.date=e.split(U.timeZoneDelimiter)[0],t=e.substr(r.date.length,e.length)));if(t){const e=U.timezone.exec(t);e?(r.time=t.replace(e[1],""),r.timezone=e[1]):r.time=t}return r}(e);let t;if(a.date){const e=function(e,r){const a=new RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+r)+"})|(\\d{2}|[+-]\\d{"+(2+r)+"})$)"),t=e.match(a);if(!t)return{year:NaN,restDateString:""};const s=t[1]?parseInt(t[1]):null,i=t[2]?parseInt(t[2]):null;return{year:null===i?s:100*i,restDateString:e.slice((t[1]||t[2]).length)}}(a.date,2);t=function(e,r){if(null===r)return new Date(NaN);const a=e.match(V);if(!a)return new Date(NaN);const t=!!a[4],s=k(a[1]),i=k(a[2])-1,n=k(a[3]),o=k(a[4]),l=k(a[5])-1;if(t)return function(e,r,a){return r>=1&&r<=53&&a>=0&&a<=6}(0,o,l)?function(e,r,a){const t=new Date(0);t.setUTCFullYear(e,0,4);const s=t.getUTCDay()||7,i=7*(r-1)+a+1-s;return t.setUTCDate(t.getUTCDate()+i),t}(r,o,l):new Date(NaN);{const e=new Date(0);return function(e,r,a){return r>=0&&r<=11&&a>=1&&a<=(F[r]||(K(e)?29:28))}(r,i,n)&&function(e,r){return r>=1&&r<=(K(e)?366:365)}(r,s)?(e.setUTCFullYear(r,i,Math.max(s,n)),e):new Date(NaN)}}(e.restDateString,e.year)}if(!t||isNaN(t.getTime()))return new Date(NaN);const s=t.getTime();let i,n=0;if(a.time&&(n=function(e){const r=e.match(P);if(!r)return NaN;const a=M(r[1]),t=M(r[2]),s=M(r[3]);if(!function(e,r,a){if(24===e)return 0===r&&0===a;return a>=0&&a<60&&r>=0&&r<60&&e>=0&&e<25}(a,t,s))return NaN;return a*I+t*E+1e3*s}(a.time),isNaN(n)))return new Date(NaN);if(!a.timezone){const e=new Date(s+n),r=new Date(0);return r.setFullYear(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()),r.setHours(e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds()),r}return i=function(e){if("Z"===e)return 0;const r=e.match(S);if(!r)return 0;const a="+"===r[1]?-1:1,t=parseInt(r[2]),s=r[3]&&parseInt(r[3])||0;if(!function(e,r){return r>=0&&r<=59}(0,s))return NaN;return a*(t*I+s*E)}(a.timezone),isNaN(i)?new Date(NaN):new Date(s+n+i)}const U={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},V=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,P=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,S=/^([+-])(\d{2})(?::?(\d{2}))?$/;function k(e){return e?parseInt(e):1}function M(e){return e&&parseFloat(e.replace(",","."))||0}const F=[31,null,31,30,31,30,31,31,30,31,30,31];function K(e){return e%400==0||e%4==0&&e%100!=0}const O="https://booking-api.reginacaeli.id/admin/borrowed-room";class L extends e{static async acceptBorrowedRoom(e,r){if(e)try{return await this._post(`${O}/${e}/accept`,r)}catch(a){throw new Error(a.message)}}static async declineBorrowedRoom(e){if(e)try{return await this._post(`${O}/${e}/decline`,{})}catch(r){throw new Error(r.message)}}}const J=[{text:"menolak",style:"text-error"},{text:"menyetujui",style:"text-success"}],Q=["badge-error","badge-warning","badge-success"],W=e=>{var r;if(!e)return[];const a=((null==e?void 0:e.borrowed_room_agreements)??[]).map((e=>({message:u.jsxs("span",{children:[e.created_by.name," telah"," ",u.jsx("span",{className:J[e.agreement_status].style,children:J[e.agreement_status].text})," ","permintaan ini."]})})));if(0===(e.pending_users??[]).length)return a;const t={message:u.jsxs("span",{children:[u.jsx("span",{className:"text-warning",children:"Menunggu konfirmasi"})," dari"," ",null==(r=e.pending_users)?void 0:r.map((e=>e.name)).join(", ")]})};return[...a,t]},Z=()=>{var e,v;const{id:I}=d(),{data:E,status:U}=N(I??""),{data:V,status:P}=_({},!1),{register:S,setValue:k,errors:M,handleManageBorrowedRoom:F,handleDeleteBorrowedRoom:K,handleAcceptBorrowedRoom:O,handleDeclineBorrowedRoom:J,handleSubmit:Z,watch:H,getValues:Y,formState:G}=((e=null)=>{const{register:d,setValue:m,getValues:u,formState:{errors:c},handleSubmit:p,watch:f,reset:h,formState:b}=g(),[w,x]=r(a),N=t(),y=s(),{data:v}=_({},!1);return i.useEffect((()=>{var r;if(h(),e){if(Object.keys(e).filter((e=>!["room_items","item_id"].includes(e))).forEach((r=>{m(r,e[r])})),!v)return;null==(r=e.borrowed_room_items)||r.map((e=>{var r;const a=f("room_id"),t=v.find((e=>e.id===a)),s=((null==(r=null==t?void 0:t.room_items)?void 0:r.map((e=>e.item_id)))??[]).indexOf(e.item_id);void 0!==s&&(s<0||(m(`items.${s}.item_id`,e.item_id),m(`items.${s}.quantity`,e.quantity)))}))}}),[e,m,v]),{register:d,setValue:m,errors:c,handleManageBorrowedRoom:async function(r){if(!w){r={...r,items:r.items.filter((e=>!!e.item_id))},x(!0);try{e?await n.promise(j.updateBorrowedRoom(e.id,r),{pending:"Waiting for update borrowed room!",error:o(),success:l()}):await n.promise(j.createBorrowedRoom(r),{pending:"Waiting for create borrowed room!",error:o(),success:l()})}catch(a){}N.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&N.invalidateQueries({queryKey:["general/borrowed-room",e.id]}),x(!1)}},handleDeleteBorrowedRoom:async function(){if(e&&!w){x(!0);try{await n.promise(j.deleteBorrowedRoom(e.id),{pending:"Waiting for delete borrowed room!",error:o(),success:l()})}catch(r){}x(!1),h(),N.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&N.invalidateQueries({queryKey:["general/borrowed-room",e.id]}),y("/room-request")}},handleAcceptBorrowedRoom:async function(){if(!e)return;if(w)return;const r=u("start_borrowing_time");x(!0);try{await n.promise(L.acceptBorrowedRoom(e.id,{start_borrowing_time:r}),{pending:"Waiting for accept borrowed room!",error:o(),success:l()})}catch(a){}x(!1),N.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e?N.invalidateQueries({queryKey:["general/borrowed-room",e.id]}):y("/room-request")},handleDeclineBorrowedRoom:async function(){if(e&&!w){x(!0);try{await n.promise(L.declineBorrowedRoom(e.id),{pending:"Waiting for decline borrowed room!",error:o(),success:l()})}catch(r){}x(!1),N.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&N.invalidateQueries({queryKey:["general/borrowed-room",e.id]})}},handleSubmit:p,watch:f,getValues:u,formState:b}})(E),X=H("room_id"),ee=H("borrowed_date"),[re,ae]=i.useState(!1),{user:te}=m(),se=((e,r,a,t)=>{if(!r)return"CREATE";if(!a)return"LOADING";if("pending"===e)return"LOADING";if("error"===e)return"ERROR";if(!t)return"CREATE";if(t.borrowed_by_user_id===a.id)return t.borrowed_status===D?t.borrowed_room_agreements.length>0?"CONFIRMED":"UPDATE":t.borrowed_status===C?"CONFIRMED":"UPDATE";const s=t.pending_users??[];return 0===s.length?"UPDATE":t.borrowed_status===D?s.filter((e=>e.id===a.id)).length>0?"CONFIRMATION":"UPDATE":"CONFIRMED"})(U,I,te,E),ie=["CREATE","UPDATE"].includes(se);const ne=(e=>["CONFIRMATION"].includes(e))(se);i.useEffect((()=>{if("success"!==P)return;if(re)return;if(E)return;ae(!0);k("room_id",V[0].id)}),[re,P]),i.useEffect((()=>{I&&E&&te&&(2!==E.borrowed_status||te.role)}),[te,E]);const{data:oe,status:le}=y(X,{borrowing_date:ee,borrowed_room_id:I,check_schedule:G.isDirty});return u.jsx("section",{className:"flex flex-col h-full flex-1 gap-4 mb-8 divide-y",children:u.jsxs("div",{className:"flex flex-col",children:[u.jsx(x,{pageName:(I?"":"Buat ")+"Proposal Pinjam Ruang",action:"pending"===U&&I?u.jsx("span",{className:"loading loading-dots loading-xs"}):E&&null!==(null==E?void 0:E.borrowed_status)?u.jsx("div",{className:c("badge badge-outline px-4 py-3",Q[null==E?void 0:E.borrowed_status]),children:R[null==E?void 0:E.borrowed_status]}):u.jsx(u.Fragment,{})}),u.jsx(w,{notification:W(E)}),u.jsxs("form",{onSubmit:Z(F),className:"grid grid-cols-6 gap-4 mx-6",children:[u.jsx("div",{className:"col-span-6 sm:col-span-5",children:u.jsx(f,{label:"Nama Kegiatan",type:"text",name:"event_name",placeholder:"Contoh: Acara Natal",disabled:!ie,register:S("event_name",{required:"Nama kegiatan harus diisi"}),setValue:k,errors:M,isLoading:"pending"===U&&!!I})}),u.jsx("div",{className:"col-span-6 sm:col-span-2",children:u.jsx(f,{label:"Nama PIC",type:"text",name:"pic_name",placeholder:"Tuliskan nama anda",disabled:!ie,register:S("pic_name",{required:"Nama PIC harus diisi"}),setValue:k,errors:M,isLoading:"pending"===U&&!!I})}),u.jsx("div",{className:"col-span-6 sm:col-span-2",children:u.jsx(f,{label:"No. Telp PIC",type:"text",name:"pic_phone_number",placeholder:"Format: 08.....",disabled:!ie,register:S("pic_phone_number",{required:"No. Telp PIC harus diisi"}),setValue:k,errors:M,isLoading:"pending"===U&&!!I})}),u.jsx("div",{className:"col-span-6 sm:col-span-2",children:u.jsx(f,{label:"Tanggal Pinjam Ruangan",type:"date",name:"borrowed_date",disabled:!ie,register:S("borrowed_date",{required:"Tanggal peminjaman harus diisi",validate:e=>{const r=B(e),a=new Date;return!(!A(r,a)&&(t=r,s=a,+q(t)!=+q(s)))||"Tanggal peminjaman harus setelah hari ini";var t,s}}),setValue:k,errors:M,isLoading:"pending"===U&&!!I})}),u.jsx("div",{className:"col-span-6 sm:col-span-2",children:u.jsx(f,{disabled:!ie,label:"Kapasitas",type:"number",name:"capacity",register:S("capacity",{required:"Kapasitas harus diisi"}),setValue:k,errors:M,isLoading:"pending"===U&&!!I})}),u.jsx("div",{className:"col-span-6 sm:col-span-4",children:u.jsx(p,{disabled:!ie,label:"Ruangan",name:"room_id",register:S("room_id",{required:"Ruangan harus diisi"}),setValue:k,model:(V??[]).map((e=>({id:e.id,name:e.name+" ("+e.floor.name+")"})))??[],errors:M,description:"success"===le?u.jsxs("div",{className:"flex flex-col text-sm mt-2",children:[u.jsx("span",{children:"Tersedia pada"}),u.jsx("ul",{children:(oe??[]).map(((e,r)=>u.jsxs("li",{className:"ml-2",children:["âœ“ ",e]},r)))})]}):u.jsx(u.Fragment,{}),isLoading:"pending"===P})}),u.jsx("div",{className:"col-span-6 sm:col-span-2",children:u.jsx(f,{disabled:!ie,label:"Jam Mulai Pinjam",type:"time",step:T,name:"start_borrowing_time",register:S("start_borrowing_time",{required:"Jam mulai pinjam harus diisi"}),setValue:k,errors:M,isLoading:"pending"===U&&!!I})}),u.jsx("div",{className:"col-span-6 sm:col-span-2",children:u.jsx(f,{disabled:!ie,label:"Jam Mulai Acara",type:"time",step:T,name:"start_event_time",register:S("start_event_time",{required:"Jam mulai acara harus diisi",validate:e=>{const r=Y("start_borrowing_time"),a=new Date(`2000-01-01T${r}`),t=new Date(`2000-01-01T${e}`);if(s=a,+$(t)<+$(s))return"Jam mulai harus setelah jam mulai pinjam";var s}}),setValue:k,errors:M,isLoading:"pending"===U&&!!I})}),u.jsx("div",{className:"col-span-6 sm:col-span-2",children:u.jsx(f,{disabled:!ie,label:"Jam Selesai Pinjam",type:"time",step:T,name:"end_event_time",register:S("end_event_time",{required:"Jam akhir harus diisi",validate:e=>{const r=Y("start_event_time"),a=new Date(`2000-01-01T${r}`);if(!A(new Date(`2000-01-01T${e}`),a))return"Jam akhir event harus setelah jam mulai event"}}),setValue:k,errors:M,isLoading:"pending"===U&&!!I})}),u.jsx("div",{className:"col-span-6 sm:col-span-4",children:"pending"===P?u.jsx(z,{}):X&&V&&(null==(v=null==(e=V.find((e=>e.id===X)))?void 0:e.room_items)?void 0:v.map(((e,r)=>{const a=H(`items.${r}.item_id`);return u.jsxs("div",{className:"grid grid-cols-3 items-center",children:[u.jsx(b,{disabled:!ie,label:e.item.name,name:`items.${r}.item_id`,id:`items.${r}.item_id`,value:e.item_id,register:S(`items.${r}.item_id`),inputContainerClassName:"col-span-2",errors:M}),!!a&&u.jsx(f,{type:"number",disabled:!ie,inputClassName:"input-sm",placeholder:"Jumlah barang",min:1,name:`items.${r}.quantity`,id:`items.${r}.quantity`,register:S(`items.${r}.quantity`,{required:"Harus diisi"}),setValue:k,errors:M})]},e.id)})))}),u.jsx("div",{className:"col-span-6",children:u.jsx(h,{disabled:!ie,label:"Keterangan",name:"description",id:"description",register:S("description",{required:"Keterangan harus diisi"}),setValue:k,errors:M})}),["UPDATE","CREATE"].includes(se)&&u.jsxs("div",{className:"col-span-6 modal-action flex-row-reverse justify-between",children:[u.jsxs("div",{className:"flex flex-row gap-4",children:[u.jsx("button",{className:"btn btn-neutral",type:"button",children:"Tutup"}),u.jsx("button",{className:"btn btn-primary",type:"submit",children:E?"Ubah":"Buat"})]}),E&&u.jsx("button",{className:"btn !ml-0 btn-error",type:"button",onClick:()=>K(),children:"Hapus"})]}),ne&&u.jsxs("div",{className:"col-span-6 modal-action flex-row-reverse justify-between",children:[u.jsx("button",{className:"btn btn-primary",onClick:Z((async()=>await O())),children:"Setujui"}),u.jsx("button",{className:"btn !ml-0 btn-error",type:"button",onClick:async()=>{await J()},children:"Tolak"})]})]})]})})},z=()=>u.jsxs("div",{className:"flex flex-row gap-4 px-1 items-center",children:[u.jsx("div",{className:"bg-base-300 min-w-12 animate-pulse rounded-full h-7"}),u.jsx("div",{className:"bg-base-300 min-w-32 animate-pulse rounded-full h-6"})]});export{Z as default};
