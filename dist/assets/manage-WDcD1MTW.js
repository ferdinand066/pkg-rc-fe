import{B as e,c as a,f as r,h as t,m as s,r as i,Q as n,i as o,k as l,x as d,a as m,j as c,P as u,t as p}from"./index-DKCzlmL8.js";import{I as g}from"./InputSelect-DWZcUY0v.js";import{u as f,I as b}from"./InputText-Dazzv9d1.js";import{I as h}from"./InputTextarea-BeDnMVqT.js";import{I as w}from"./InputToggle-BdHIy1Ns.js";import{A as x}from"./AlertContainer-DboORU2d.js";import{B as j,a as _}from"./use-borrowed-room-DHWJ_9eQ.js";import{u as y,a as N}from"./use-room--c7RyRFy.js";import{A as v,I as D,b as T}from"./constants-D51TbJpq.js";import{s as q,b as C,c as $}from"./startOfDay-Cqt31xqJ.js";import{t as R}from"./isValid-5aXsojdQ.js";import"./useQuery-Dse7ilVx.js";function B(e,a){const r=R(e),t=R(a);return r.getTime()>t.getTime()}function I(e,a){const r=function(e){const a={},r=e.split(V.dateTimeDelimiter);let t;if(r.length>2)return a;/:/.test(r[0])?t=r[0]:(a.date=r[0],t=r[1],V.timeZoneDelimiter.test(a.date)&&(a.date=e.split(V.timeZoneDelimiter)[0],t=e.substr(a.date.length,e.length)));if(t){const e=V.timezone.exec(t);e?(a.time=t.replace(e[1],""),a.timezone=e[1]):a.time=t}return a}(e);let t;if(r.date){const e=function(e,a){const r=new RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+a)+"})|(\\d{2}|[+-]\\d{"+(2+a)+"})$)"),t=e.match(r);if(!t)return{year:NaN,restDateString:""};const s=t[1]?parseInt(t[1]):null,i=t[2]?parseInt(t[2]):null;return{year:null===i?s:100*i,restDateString:e.slice((t[1]||t[2]).length)}}(r.date,2);t=function(e,a){if(null===a)return new Date(NaN);const r=e.match(S);if(!r)return new Date(NaN);const t=!!r[4],s=U(r[1]),i=U(r[2])-1,n=U(r[3]),o=U(r[4]),l=U(r[5])-1;if(t)return function(e,a,r){return a>=1&&a<=53&&r>=0&&r<=6}(0,o,l)?function(e,a,r){const t=new Date(0);t.setUTCFullYear(e,0,4);const s=t.getUTCDay()||7,i=7*(a-1)+r+1-s;return t.setUTCDate(t.getUTCDate()+i),t}(a,o,l):new Date(NaN);{const e=new Date(0);return function(e,a,r){return a>=0&&a<=11&&r>=1&&r<=(J[a]||(L(e)?29:28))}(a,i,n)&&function(e,a){return a>=1&&a<=(L(e)?366:365)}(a,s)?(e.setUTCFullYear(a,i,Math.max(s,n)),e):new Date(NaN)}}(e.restDateString,e.year)}if(!t||isNaN(t.getTime()))return new Date(NaN);const s=t.getTime();let i,n=0;if(r.time&&(n=function(e){const a=e.match(k);if(!a)return NaN;const r=P(a[1]),t=P(a[2]),s=P(a[3]);if(!function(e,a,r){if(24===e)return 0===a&&0===r;return r>=0&&r<60&&a>=0&&a<60&&e>=0&&e<25}(r,t,s))return NaN;return r*C+t*$+1e3*s}(r.time),isNaN(n)))return new Date(NaN);if(!r.timezone){const e=new Date(s+n),a=new Date(0);return a.setFullYear(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()),a.setHours(e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds()),a}return i=function(e){if("Z"===e)return 0;const a=e.match(K);if(!a)return 0;const r="+"===a[1]?-1:1,t=parseInt(a[2]),s=a[3]&&parseInt(a[3])||0;if(!function(e,a){return a>=0&&a<=59}(0,s))return NaN;return r*(t*C+s*$)}(r.timezone),isNaN(i)?new Date(NaN):new Date(s+n+i)}const V={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},S=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,k=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,K=/^([+-])(\d{2})(?::?(\d{2}))?$/;function U(e){return e?parseInt(e):1}function P(e){return e&&parseFloat(e.replace(",","."))||0}const J=[31,null,31,30,31,30,31,31,30,31,30,31];function L(e){return e%400==0||e%4==0&&e%100!=0}const M="https://booking-api.reginacaeli.id/admin/borrowed-room";class Q extends e{static async acceptBorrowedRoom(e,a){if(e)try{return await this._post(`${M}/${e}/accept`,a)}catch(r){throw new Error(r.message)}}static async declineBorrowedRoom(e){if(e)try{return await this._post(`${M}/${e}/decline`,{})}catch(a){throw new Error(a.message)}}}const F=[{text:"menolak",style:"text-error"},{text:"menyetujui",style:"text-success"}],A=["badge-error","badge-warning","badge-success"],E=e=>{var a;if(!e)return[];const r=((null==e?void 0:e.borrowed_room_agreements)??[]).map((e=>({message:c.jsxs("span",{children:[e.created_by.name," telah"," ",c.jsx("span",{className:F[e.agreement_status].style,children:F[e.agreement_status].text})," ","permintaan ini."]})})));if(0===(e.pending_users??[]).length)return r;const t={message:c.jsxs("span",{children:[c.jsx("span",{className:"text-warning",children:"Menunggu konfirmasi"})," dari"," ",null==(a=e.pending_users)?void 0:a.map((e=>e.name)).join(", ")]})};return[...r,t]},W=()=>{var e,C;const{id:$}=d(),{data:V,status:S}=_($??""),{data:k,status:K}=y({},!1),{register:U,setValue:P,errors:J,handleManageBorrowedRoom:L,handleDeleteBorrowedRoom:M,handleAcceptBorrowedRoom:F,handleDeclineBorrowedRoom:W,handleSubmit:z,watch:H,getValues:Y,formState:O}=((e=null)=>{const{register:d,setValue:m,getValues:c,formState:{errors:u},handleSubmit:p,watch:g,reset:b,formState:h}=f(),[w,x]=a(r),_=t(),N=s(),{data:v}=y({},!1);return i.useEffect((()=>{var a;if(b(),e){if(Object.keys(e).filter((e=>!["room_items","item_id"].includes(e))).forEach((a=>{m(a,e[a])})),!v)return;null==(a=e.borrowed_room_items)||a.map((e=>{var a;const r=g("room_id"),t=v.find((e=>e.id===r)),s=((null==(a=null==t?void 0:t.room_items)?void 0:a.map((e=>e.item_id)))??[]).indexOf(e.item_id);void 0!==s&&(s<0||(m(`items.${s}.item_id`,e.item_id),m(`items.${s}.quantity`,e.quantity)))}))}}),[e,m,v]),{register:d,setValue:m,errors:u,handleManageBorrowedRoom:async function(a){if(!w){a={...a,items:a.items.filter((e=>!!e.item_id))},x(!0);try{e?await n.promise(j.updateBorrowedRoom(e.id,a),{pending:"Waiting for update borrowed room!",error:o(),success:l()}):await n.promise(j.createBorrowedRoom(a),{pending:"Waiting for create borrowed room!",error:o(),success:l()})}catch(r){}_.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&_.invalidateQueries({queryKey:["general/borrowed-room",e.id]}),x(!1)}},handleDeleteBorrowedRoom:async function(){if(e&&!w){x(!0);try{await n.promise(j.deleteBorrowedRoom(e.id),{pending:"Waiting for delete borrowed room!",error:o(),success:l()})}catch(a){}x(!1),b(),_.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&_.invalidateQueries({queryKey:["general/borrowed-room",e.id]}),N("/room-request")}},handleAcceptBorrowedRoom:async function(){if(!e)return;if(w)return;const a=c("start_borrowing_time");x(!0);try{await n.promise(Q.acceptBorrowedRoom(e.id,{start_borrowing_time:a}),{pending:"Waiting for accept borrowed room!",error:o(),success:l()})}catch(r){}x(!1),_.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e?_.invalidateQueries({queryKey:["general/borrowed-room",e.id]}):N("/room-request")},handleDeclineBorrowedRoom:async function(){if(e&&!w){x(!0);try{await n.promise(Q.declineBorrowedRoom(e.id),{pending:"Waiting for decline borrowed room!",error:o(),success:l()})}catch(a){}x(!1),_.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&_.invalidateQueries({queryKey:["general/borrowed-room",e.id]})}},handleSubmit:p,watch:g,getValues:c,formState:h}})(V),G=H("room_id"),X=H("borrowed_date"),[ee,ae]=i.useState(!1),[re,te]=i.useState(!1),{user:se}=m();i.useEffect((()=>{if("success"!==K)return;if(ee)return;if(V)return;ae(!0);P("room_id",k[0].id)}),[ee,K]),i.useEffect((()=>{$?V&&se&&(2===V.borrowed_status&&se.role!==v||V.borrowed_by_user_id!==se.id&&se.role!==v||te(!0)):te(!0)}),[se,V]);const{data:ie,status:ne}=N(G,{borrowing_date:X,borrowed_room_id:$,check_schedule:re&&O.isDirty});return c.jsx("section",{className:"flex flex-col h-full flex-1 gap-4 mb-8 divide-y",children:c.jsxs("div",{className:"flex flex-col",children:[c.jsx(u,{pageName:($?"":"Buat ")+"Proposal Pinjam Ruang",action:"pending"===S&&$?c.jsx("span",{className:"loading loading-dots loading-xs"}):V&&null!==(null==V?void 0:V.borrowed_status)?c.jsx("div",{className:p("badge badge-outline px-4 py-3",A[null==V?void 0:V.borrowed_status]),children:T[null==V?void 0:V.borrowed_status]}):c.jsx(c.Fragment,{})}),c.jsx(x,{notification:E(V)}),c.jsxs("form",{onSubmit:z(L),className:"grid grid-cols-6 gap-4 mx-6",children:[c.jsx("div",{className:"col-span-6 sm:col-span-5",children:c.jsx(b,{label:"Nama Kegiatan",type:"text",name:"event_name",placeholder:"Contoh: Acara Natal",disabled:!re,register:U("event_name",{required:"Nama kegiatan harus diisi"}),setValue:P,errors:J,isLoading:"pending"===S&&!!$})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{label:"Nama PIC",type:"text",name:"pic_name",placeholder:"Tuliskan nama anda",disabled:!re,register:U("pic_name",{required:"Nama PIC harus diisi"}),setValue:P,errors:J,isLoading:"pending"===S&&!!$})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{label:"No. Telp PIC",type:"text",name:"pic_phone_number",placeholder:"Format: 08.....",disabled:!re,register:U("pic_phone_number",{required:"No. Telp PIC harus diisi"}),setValue:P,errors:J,isLoading:"pending"===S&&!!$})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{label:"Tanggal Pinjam Ruangan",type:"date",name:"borrowed_date",disabled:!re,register:U("borrowed_date",{required:"Tanggal peminjaman harus diisi",validate:e=>{const a=I(e),r=new Date;return!(!B(a,r)&&(t=a,s=r,+q(t)!=+q(s)))||"Tanggal peminjaman harus setelah hari ini";var t,s}}),setValue:P,errors:J,isLoading:"pending"===S&&!!$})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{disabled:!re,label:"Kapasitas",type:"number",name:"capacity",register:U("capacity",{required:"Kapasitas harus diisi"}),setValue:P,errors:J,isLoading:"pending"===S&&!!$})}),c.jsx("div",{className:"col-span-6 sm:col-span-4",children:c.jsx(g,{disabled:!re,label:"Ruangan",name:"room_id",register:U("room_id",{required:"Ruangan harus diisi"}),setValue:P,model:(k??[]).map((e=>({id:e.id,name:e.name+" ("+e.floor.name+")"})))??[],errors:J,description:"success"===ne?c.jsxs("div",{className:"flex flex-col text-sm mt-2",children:[c.jsx("span",{children:"Tersedia pada"}),c.jsx("ul",{children:(ie??[]).map(((e,a)=>c.jsxs("li",{className:"ml-2",children:["âœ“ ",e]},a)))})]}):c.jsx(c.Fragment,{}),isLoading:"pending"===K})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{disabled:2===(null==V?void 0:V.borrowed_status),label:"Jam Mulai Pinjam",type:"time",step:D,name:"start_borrowing_time",register:U("start_borrowing_time",{required:"Jam mulai pinjam harus diisi"}),setValue:P,errors:J,isLoading:"pending"===S&&!!$})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{disabled:!re,label:"Jam Mulai Acara",type:"time",step:D,name:"start_event_time",register:U("start_event_time",{required:"Jam mulai acara harus diisi",validate:e=>{const a=Y("start_borrowing_time"),r=new Date(`2000-01-01T${a}`),t=new Date(`2000-01-01T${e}`);if(s=r,+R(t)<+R(s))return"Jam mulai harus setelah jam mulai pinjam";var s}}),setValue:P,errors:J,isLoading:"pending"===S&&!!$})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{disabled:!re,label:"Jam Selesai Pinjam",type:"time",step:D,name:"end_event_time",register:U("end_event_time",{required:"Jam akhir harus diisi",validate:e=>{const a=Y("start_event_time"),r=new Date(`2000-01-01T${a}`);if(!B(new Date(`2000-01-01T${e}`),r))return"Jam akhir event harus setelah jam mulai event"}}),setValue:P,errors:J,isLoading:"pending"===S&&!!$})}),c.jsx("div",{className:"col-span-6 sm:col-span-4",children:"pending"===K?c.jsx(Z,{}):G&&k&&(null==(C=null==(e=k.find((e=>e.id===G)))?void 0:e.room_items)?void 0:C.map(((e,a)=>{const r=H(`items.${a}.item_id`);return c.jsxs("div",{className:"grid grid-cols-3 items-center",children:[c.jsx(w,{disabled:!re,label:e.item.name,name:`items.${a}.item_id`,id:`items.${a}.item_id`,value:e.item_id,register:U(`items.${a}.item_id`),inputContainerClassName:"col-span-2",errors:J}),!!r&&c.jsx(b,{type:"number",disabled:!re,inputClassName:"input-sm",placeholder:"Jumlah barang",min:1,name:`items.${a}.quantity`,id:`items.${a}.quantity`,register:U(`items.${a}.quantity`,{required:"Harus diisi"}),setValue:P,errors:J})]},e.id)})))}),c.jsx("div",{className:"col-span-6",children:c.jsx(h,{disabled:!re,label:"Keterangan",name:"description",id:"description",register:U("description",{required:"Keterangan harus diisi"}),setValue:P,errors:J})}),re&&c.jsxs("div",{className:"col-span-6 modal-action flex-row-reverse justify-between",children:[c.jsxs("div",{className:"flex flex-row gap-4",children:[c.jsx("button",{className:"btn btn-neutral",type:"button",children:"Tutup"}),c.jsx("button",{className:"btn btn-primary",type:"submit",children:V?"Ubah":"Buat"})]}),V&&c.jsx("button",{className:"btn !ml-0 btn-error",type:"button",onClick:()=>M(),children:"Hapus"})]}),se&&se.role===v&&!re&&V&&1===V.borrowed_status&&0===((null==V?void 0:V.borrowed_room_agreements)??[]).filter((e=>e.created_by_user_id===se.id)).length&&c.jsxs("div",{className:"col-span-6 modal-action flex-row-reverse justify-between",children:[c.jsx("button",{className:"btn btn-primary",onClick:z((async()=>await F())),children:"Setujui"}),c.jsx("button",{className:"btn !ml-0 btn-error",type:"button",onClick:async()=>{await W()},children:"Tolak"})]})]})]})})},Z=()=>c.jsxs("div",{className:"flex flex-row gap-4 px-1 items-center",children:[c.jsx("div",{className:"bg-base-300 min-w-12 animate-pulse rounded-full h-7"}),c.jsx("div",{className:"bg-base-300 min-w-32 animate-pulse rounded-full h-6"})]});export{W as default};
