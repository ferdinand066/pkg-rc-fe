import{B as e,c as a,f as r,h as s,m as i,r as t,Q as n,i as o,k as d,x as l,a as m,j as c,t as u}from"./index-BmJ25h3X.js";import{I as p}from"./InputSelect-CmwJI9Yu.js";import{u as g,I as b}from"./InputText-pAr3FQB2.js";import{I as h}from"./InputTextarea-De71hbV7.js";import{I as x}from"./InputToggle-o0YEZmRa.js";import{A as f}from"./AlertContainer-BkgnwiPt.js";import{P as j}from"./PageHeader-DnEFgu0F.js";import{B as w,b as _,p as y,i as v,a as N}from"./use-borrowed-room-jvlHm8mS.js";import{u as R,a as T}from"./use-room-B_ALCFA-.js";import{A as q,I as E,B as A,c as D,b as I}from"./constants-5vXSpW5c.js";import{t as C}from"./isValid-5aXsojdQ.js";import"./startOfDay-Do9sk2vp.js";import"./useQuery-BAiGwM-i.js";const B="https://booking-api.reginacaeli.id/admin/borrowed-room";class V extends e{static async acceptBorrowedRoom(e,a){if(e)try{return await this._post(`${B}/${e}/accept`,a)}catch(r){throw new Error(r.message)}}static async declineBorrowedRoom(e){if(e)try{return await this._post(`${B}/${e}/decline`,{})}catch(a){throw new Error(a.message)}}}const P=[{text:"menolak",style:"text-error"},{text:"menyetujui",style:"text-success"}],$=["badge-error","badge-warning","badge-success"],k=e=>{var a;if(!e)return[];const r=((null==e?void 0:e.borrowed_room_agreements)??[]).map((e=>({message:c.jsxs("span",{children:[e.created_by.name," telah"," ",c.jsx("span",{className:P[e.agreement_status].style,children:P[e.agreement_status].text})," ","permintaan ini."]})})));if(0===(e.pending_users??[]).length)return r;const s={message:c.jsxs("span",{children:[c.jsx("span",{className:"text-warning",children:"Menunggu konfirmasi"})," dari"," ",null==(a=e.pending_users)?void 0:a.map((e=>e.name)).join(", ")]})};return[...r,s]},K=()=>{var e,q;const{id:B}=l(),{data:P,status:K}=_(B??""),{data:S,status:L}=R({},{order_by:"name",data_order:"asc"},!1),{register:M,setValue:J,errors:Q,handleManageBorrowedRoom:F,handleDeleteBorrowedRoom:U,handleAcceptBorrowedRoom:W,handleDeclineBorrowedRoom:H,handleSubmit:G,watch:z,getValues:X,formState:Y}=((e=null)=>{const{register:l,setValue:m,getValues:c,formState:{errors:u},handleSubmit:p,watch:b,reset:h,formState:x}=g(),[f,j]=a(r),_=s(),y=i(),{data:v}=R({},{order_by:"name",data_order:"asc"},!1);return t.useEffect((()=>{var a;if(h(),e){if(Object.keys(e).filter((e=>!["room_items","item_id"].includes(e))).forEach((a=>{m(a,e[a])})),!v)return;null==(a=e.borrowed_room_items)||a.map((e=>{var a;const r=b("room_id"),s=v.find((e=>e.id===r)),i=((null==(a=null==s?void 0:s.room_items)?void 0:a.map((e=>e.item_id)))??[]).indexOf(e.item_id);void 0!==i&&(i<0||(m(`items.${i}.item_id`,e.item_id),m(`items.${i}.quantity`,e.quantity)))}))}}),[e,m,v]),{register:l,setValue:m,errors:u,handleManageBorrowedRoom:async function(a){if(!f){a={...a,items:a.items.filter((e=>!!e.item_id))},j(!0);try{e?await n.promise(w.updateBorrowedRoom(e.id,a),{pending:"Waiting for update borrowed room!",error:o(),success:d()}):await n.promise(w.createBorrowedRoom(a),{pending:"Waiting for create borrowed room!",error:o(),success:d()})}catch(r){}_.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&_.invalidateQueries({queryKey:["general/borrowed-room",e.id]}),j(!1)}},handleDeleteBorrowedRoom:async function(){if(e&&!f){j(!0);try{await n.promise(w.deleteBorrowedRoom(e.id),{pending:"Waiting for delete borrowed room!",error:o(),success:d()})}catch(a){}j(!1),h(),_.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&_.invalidateQueries({queryKey:["general/borrowed-room",e.id]}),y("/room-request")}},handleAcceptBorrowedRoom:async function(){if(!e)return;if(f)return;const a=c("start_borrowing_time");j(!0);try{await n.promise(V.acceptBorrowedRoom(e.id,{start_borrowing_time:a}),{pending:"Waiting for accept borrowed room!",error:o(),success:d()})}catch(r){}j(!1),_.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e?_.invalidateQueries({queryKey:["general/borrowed-room",e.id]}):y("/room-request")},handleDeclineBorrowedRoom:async function(){if(e&&!f){j(!0);try{await n.promise(V.declineBorrowedRoom(e.id),{pending:"Waiting for decline borrowed room!",error:o(),success:d()})}catch(a){}j(!1),_.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&_.invalidateQueries({queryKey:["general/borrowed-room",e.id]})}},handleSubmit:p,watch:b,getValues:c,formState:x}})(P),Z=z("room_id"),ee=z("borrowed_date"),[ae,re]=t.useState(!1),{user:se}=m(),ie=((e,a,r,s)=>{if(!a)return"CREATE";if(!r)return"LOADING";if("pending"===e)return"LOADING";if("error"===e)return"ERROR";if(!s)return"CREATE";if(s.borrowed_by_user_id===r.id)return s.borrowed_status===A?s.borrowed_room_agreements.length>0?"CONFIRMED":"UPDATE":s.borrowed_status===D?"CONFIRMED":"UPDATE";const i=s.pending_users??[];return 0===i.length?"UPDATE":s.borrowed_status===A?i.filter((e=>e.id===r.id)).length>0?"CONFIRMATION":"UPDATE":"CONFIRMED"})(K,B,se,P),te=["CREATE","UPDATE"].includes(ie);const ne=(e=>["CONFIRMATION"].includes(e))(ie);t.useEffect((()=>{if("success"!==L)return;if(ae)return;if(P)return;re(!0);J("room_id",S[0].id)}),[ae,L]),t.useEffect((()=>{B&&P&&se&&(2!==P.borrowed_status||se.role)}),[se,P]);const{data:oe,status:de}=T(Z,{borrowing_date:ee,borrowed_room_id:B,check_schedule:Y.isDirty});return c.jsx("section",{className:"flex flex-col h-full flex-1 gap-4 mb-8 divide-y",children:c.jsxs("div",{className:"flex flex-col",children:[c.jsx(j,{pageName:(B?"":"Buat ")+"Proposal Pinjam Ruang",action:"pending"===K&&B?c.jsx("span",{className:"loading loading-dots loading-xs"}):P&&null!==(null==P?void 0:P.borrowed_status)?c.jsx("div",{className:u("badge badge-outline px-4 py-3",$[null==P?void 0:P.borrowed_status]),children:I[null==P?void 0:P.borrowed_status]}):c.jsx(c.Fragment,{})}),c.jsx(f,{notification:k(P)}),c.jsxs("form",{onSubmit:G(F),className:"grid grid-cols-6 gap-4 mx-6",children:[c.jsx("div",{className:"col-span-6 sm:col-span-5",children:c.jsx(b,{label:"Nama Kegiatan",type:"text",name:"event_name",placeholder:"Contoh: Acara Natal",disabled:!te,register:M("event_name",{required:"Nama kegiatan harus diisi"}),setValue:J,errors:Q,isLoading:"pending"===K&&!!B})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{label:"Nama PIC",type:"text",name:"pic_name",placeholder:"Tuliskan nama anda",disabled:!te,register:M("pic_name",{required:"Nama PIC harus diisi"}),setValue:J,errors:Q,isLoading:"pending"===K&&!!B})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{label:"No. Telp PIC",type:"text",name:"pic_phone_number",placeholder:"Format: 08.....",disabled:!te,register:M("pic_phone_number",{required:"No. Telp PIC harus diisi"}),setValue:J,errors:Q,isLoading:"pending"===K&&!!B})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{label:"Tanggal Pinjam Ruangan",type:"date",name:"borrowed_date",disabled:!te,register:M("borrowed_date",{required:"Tanggal peminjaman harus diisi",validate:e=>{const a=y(e),r=new Date;return!(!v(a,r)&&!N(a,r))||"Tanggal peminjaman harus setelah hari ini"}}),setValue:J,errors:Q,isLoading:"pending"===K&&!!B})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{disabled:!te,label:"Kapasitas",type:"number",name:"capacity",register:M("capacity",{required:"Kapasitas harus diisi"}),setValue:J,errors:Q,isLoading:"pending"===K&&!!B})}),c.jsx("div",{className:"col-span-6 sm:col-span-4",children:c.jsx(p,{disabled:!te,label:"Ruangan",name:"room_id",register:M("room_id",{required:"Ruangan harus diisi"}),setValue:J,model:(S??[]).map((e=>({id:e.id,name:e.name+" ("+e.floor.name+")"})))??[],errors:Q,description:"success"===de?c.jsxs("div",{className:"flex flex-col text-sm mt-2",children:[c.jsx("span",{children:"Tersedia pada"}),c.jsx("ul",{children:(oe??[]).map(((e,a)=>c.jsxs("li",{className:"ml-2",children:["âœ“ ",e]},a)))})]}):c.jsx(c.Fragment,{}),isLoading:"pending"===L})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{disabled:!te,label:"Jam Mulai Pinjam",type:"time",step:E,name:"start_borrowing_time",register:M("start_borrowing_time",{required:"Jam mulai pinjam harus diisi"}),setValue:J,errors:Q,isLoading:"pending"===K&&!!B})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{disabled:!te,label:"Jam Mulai Acara",type:"time",step:E,name:"start_event_time",register:M("start_event_time",{required:"Jam mulai acara harus diisi",validate:e=>{const a=X("start_borrowing_time"),r=new Date(`2000-01-01T${a}`),s=new Date(`2000-01-01T${e}`);if(i=r,+C(s)<+C(i))return"Jam mulai harus setelah jam mulai pinjam";var i}}),setValue:J,errors:Q,isLoading:"pending"===K&&!!B})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{disabled:!te,label:"Jam Selesai Pinjam",type:"time",step:E,name:"end_event_time",register:M("end_event_time",{required:"Jam akhir harus diisi",validate:e=>{const a=X("start_event_time"),r=new Date(`2000-01-01T${a}`);if(!v(new Date(`2000-01-01T${e}`),r))return"Jam akhir event harus setelah jam mulai event"}}),setValue:J,errors:Q,isLoading:"pending"===K&&!!B})}),c.jsx("div",{className:"col-span-6 sm:col-span-4",children:"pending"===L?c.jsx(O,{}):Z&&S&&(null==(q=null==(e=S.find((e=>e.id===Z)))?void 0:e.room_items)?void 0:q.map(((e,a)=>{const r=z(`items.${a}.item_id`);return c.jsxs("div",{className:"grid grid-cols-3 items-center",children:[c.jsx(x,{disabled:!te,label:e.item.name,name:`items.${a}.item_id`,id:`items.${a}.item_id`,value:e.item_id,register:M(`items.${a}.item_id`),inputContainerClassName:"col-span-2",errors:Q}),!!r&&c.jsx(b,{type:"number",disabled:!te,inputClassName:"input-sm",placeholder:"Jumlah barang",min:1,name:`items.${a}.quantity`,id:`items.${a}.quantity`,register:M(`items.${a}.quantity`,{required:"Harus diisi"}),setValue:J,errors:Q})]},e.id)})))}),c.jsx("div",{className:"col-span-6",children:c.jsx(h,{disabled:!te,label:"Keterangan",name:"description",id:"description",register:M("description",{required:"Keterangan harus diisi"}),setValue:J,errors:Q})}),["UPDATE","CREATE"].includes(ie)&&c.jsxs("div",{className:"col-span-6 modal-action flex-row-reverse justify-between",children:[c.jsxs("div",{className:"flex flex-row gap-4",children:[c.jsx("button",{className:"btn btn-neutral",type:"button",children:"Tutup"}),c.jsx("button",{className:"btn btn-primary",type:"submit",children:P?"Ubah":"Buat"})]}),P&&c.jsx("button",{className:"btn !ml-0 btn-error",type:"button",onClick:()=>U(),children:"Hapus"})]}),ne&&c.jsxs("div",{className:"col-span-6 modal-action flex-row-reverse justify-between",children:[c.jsx("button",{className:"btn btn-primary",onClick:G((async()=>await W())),children:"Setujui"}),c.jsx("button",{className:"btn !ml-0 btn-error",type:"button",onClick:async()=>{await H()},children:"Tolak"})]})]})]})})},O=()=>c.jsxs("div",{className:"flex flex-row gap-4 px-1 items-center",children:[c.jsx("div",{className:"bg-base-300 min-w-12 animate-pulse rounded-full h-7"}),c.jsx("div",{className:"bg-base-300 min-w-32 animate-pulse rounded-full h-6"})]});export{K as default};
