import{B as e,c as a,f as r,h as s,m as i,r as t,Q as n,i as o,k as d,x as l,a as m,j as c,t as u}from"./index-Q29Gw3BZ.js";import{I as p}from"./InputSelect-DIBZSJPl.js";import{u as g,I as b}from"./InputText-CfVcbHue.js";import{I as h}from"./InputTextarea-Bl9VbB94.js";import{I as x}from"./InputToggle-VOBdqH88.js";import{A as j}from"./AlertContainer-Jolw3jAO.js";import{P as f}from"./PageHeader-B06INfxG.js";import{a as w}from"./use-borrowed-room-BZ2XK1fT.js";import{B as _,p as y,i as v,a as N}from"./borrowed-room-service-85GuJg2q.js";import{u as R,a as T}from"./use-room-B7NK_RzJ.js";import{A as E,I as C,B as q,c as A,b as D}from"./constants-5vXSpW5c.js";import{i as k}from"./isBefore-BU7b8VsE.js";import"./useQuery-C2YiQuKN.js";import"./startOfDay-Cqt31xqJ.js";import"./isValid-5aXsojdQ.js";const B="https://booking-api.reginacaeli.id/admin/borrowed-room";class I extends e{static async acceptBorrowedRoom(e,a){if(e)try{return await this._post(`${B}/${e}/accept`,a)}catch(r){throw new Error(r.message)}}static async declineBorrowedRoom(e){if(e)try{return await this._post(`${B}/${e}/decline`,{})}catch(a){throw new Error(a.message)}}}const P=[{text:"menolak",style:"text-error"},{text:"menyetujui",style:"text-success"}],V=["badge-error","badge-warning","badge-success"],$=e=>{var a;if(!e)return[];const r=((null==e?void 0:e.borrowed_room_agreements)??[]).map((e=>({message:c.jsxs("span",{children:[e.created_by.name," telah"," ",c.jsx("span",{className:P[e.agreement_status].style,children:P[e.agreement_status].text})," ","permintaan ini."]})})));if(0===(e.pending_users??[]).length)return r;const s={message:c.jsxs("span",{children:[c.jsx("span",{className:"text-warning",children:"Menunggu konfirmasi"})," dari"," ",null==(a=e.pending_users)?void 0:a.map((e=>e.name)).join(", ")]})};return[...r,s]},K=()=>{var e,E;const{id:B}=l(),{data:P,status:K}=w(B??""),{data:S,status:L}=R({},{order_by:"name",data_order:"asc"},!1),{register:M,setValue:F,errors:J,handleManageBorrowedRoom:Q,handleDeleteBorrowedRoom:U,handleAcceptBorrowedRoom:H,handleDeclineBorrowedRoom:W,handleSubmit:G,watch:z,getValues:X,formState:Y}=((e=null)=>{const{register:l,setValue:m,getValues:c,formState:{errors:u},handleSubmit:p,watch:b,reset:h,formState:x}=g(),[j,f]=a(r),w=s(),y=i(),{data:v}=R({},{order_by:"name",data_order:"asc"},!1);return t.useEffect((()=>{var a;if(h(),e){if(Object.keys(e).filter((e=>!["room_items","item_id"].includes(e))).forEach((a=>{m(a,e[a])})),!v)return;null==(a=e.borrowed_room_items)||a.map((e=>{var a;const r=b("room_id"),s=v.find((e=>e.id===r)),i=((null==(a=null==s?void 0:s.room_items)?void 0:a.map((e=>e.item_id)))??[]).indexOf(e.item_id);void 0!==i&&(i<0||(m(`items.${i}.item_id`,e.item_id),m(`items.${i}.quantity`,e.quantity)))}))}}),[e,m,v]),{register:l,setValue:m,errors:u,handleManageBorrowedRoom:async function(a){if(!j){a={...a,items:a.items.filter((e=>!!e.item_id))},f(!0);try{e?await n.promise(_.updateBorrowedRoom(e.id,a),{pending:"Waiting for update borrowed room!",error:o(),success:d()}):await n.promise(_.createBorrowedRoom(a),{pending:"Waiting for create borrowed room!",error:o(),success:d()})}catch(r){}w.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&w.invalidateQueries({queryKey:["general/borrowed-room",e.id]}),f(!1)}},handleDeleteBorrowedRoom:async function(){if(e&&!j){f(!0);try{await n.promise(_.deleteBorrowedRoom(e.id),{pending:"Waiting for delete borrowed room!",error:o(),success:d()})}catch(a){}f(!1),h(),w.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&w.invalidateQueries({queryKey:["general/borrowed-room",e.id]}),y("/room-request")}},handleAcceptBorrowedRoom:async function(){if(!e)return;if(j)return;const a=c("start_borrowing_time");f(!0);try{await n.promise(I.acceptBorrowedRoom(e.id,{start_borrowing_time:a}),{pending:"Waiting for accept borrowed room!",error:o(),success:d()})}catch(r){}f(!1),w.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e?w.invalidateQueries({queryKey:["general/borrowed-room",e.id]}):y("/room-request")},handleDeclineBorrowedRoom:async function(){if(e&&!j){f(!0);try{await n.promise(I.declineBorrowedRoom(e.id),{pending:"Waiting for decline borrowed room!",error:o(),success:d()})}catch(a){}f(!1),w.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&w.invalidateQueries({queryKey:["general/borrowed-room",e.id]})}},handleSubmit:p,watch:b,getValues:c,formState:x}})(P),Z=z("room_id"),ee=z("borrowed_date"),[ae,re]=t.useState(!1),[se,ie]=t.useState(!1),{user:te}=m(),ne=((e,a,r,s)=>{if(!a)return"CREATE";if(!r)return"LOADING";if("pending"===e)return"LOADING";if("error"===e)return"ERROR";if(!s)return"CREATE";if(s.borrowed_by_user_id===r.id)return s.borrowed_status===q?s.borrowed_room_agreements.length>0?"CONFIRMED":"UPDATE":s.borrowed_status===A?"CONFIRMED":"UPDATE";const i=s.pending_users??[];return 0===i.length?"UPDATE":s.borrowed_status===q?i.filter((e=>e.id===r.id)).length>0?"CONFIRMATION":"UPDATE":"CONFIRMED"})(K,B,te,P),oe=["CREATE","UPDATE"].includes(ne);const de=(e=>["CONFIRMATION"].includes(e))(ne);t.useEffect((()=>{if("success"!==L)return;if(ae)return;if(P)return;re(!0);F("room_id",S[0].id)}),[ae,L]),t.useEffect((()=>{B&&P&&te&&(2!==P.borrowed_status||te.role)}),[te,P]);const{data:le,status:me}=T(Z,{borrowing_date:ee,borrowed_room_id:B,check_schedule:Y.isDirty});return c.jsxs("section",{className:"flex flex-col h-full flex-1 gap-4 mb-8 divide-y",children:[c.jsxs("div",{className:"flex flex-col",children:[c.jsx(f,{pageName:(B?"":"Buat ")+"Proposal Pinjam Ruang",action:"pending"===K&&B?c.jsx("span",{className:"loading loading-dots loading-xs"}):P&&null!==(null==P?void 0:P.borrowed_status)?c.jsx("div",{className:u("badge badge-outline px-4 py-3",V[null==P?void 0:P.borrowed_status]),children:D[null==P?void 0:P.borrowed_status]}):c.jsx(c.Fragment,{})}),c.jsx(j,{notification:$(P)}),c.jsxs("form",{onSubmit:G(Q),className:"grid grid-cols-6 gap-4 mx-6",children:[c.jsx("div",{className:"col-span-6 sm:col-span-5",children:c.jsx(b,{label:"Nama Kegiatan",type:"text",name:"event_name",placeholder:"Contoh: Acara Natal",disabled:!oe,register:M("event_name",{required:"Nama kegiatan harus diisi"}),setValue:F,errors:J,isLoading:"pending"===K&&!!B})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{label:"Nama PIC",type:"text",name:"pic_name",placeholder:"Tuliskan nama anda",disabled:!oe,register:M("pic_name",{required:"Nama PIC harus diisi"}),setValue:F,errors:J,isLoading:"pending"===K&&!!B})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{label:"No. Telp PIC",type:"text",name:"pic_phone_number",placeholder:"Format: 08.....",disabled:!oe,register:M("pic_phone_number",{required:"No. Telp PIC harus diisi"}),setValue:F,errors:J,isLoading:"pending"===K&&!!B})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{label:"Tanggal Pinjam Ruangan",type:"date",name:"borrowed_date",disabled:!oe,register:M("borrowed_date",{required:"Tanggal peminjaman harus diisi",validate:e=>{const a=y(e),r=new Date;return!(!v(a,r)&&!N(a,r))||"Tanggal peminjaman harus setelah hari ini"}}),setValue:F,errors:J,isLoading:"pending"===K&&!!B})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{disabled:!oe,label:"Kapasitas",type:"number",name:"capacity",register:M("capacity",{required:"Kapasitas harus diisi"}),setValue:F,errors:J,isLoading:"pending"===K&&!!B})}),c.jsx("div",{className:"col-span-6 sm:col-span-4",children:c.jsx(p,{disabled:!oe,label:"Ruangan",name:"room_id",register:M("room_id",{required:"Ruangan harus diisi"}),setValue:F,model:(S??[]).map((e=>({id:e.id,name:e.name+" ("+e.floor.name+")"})))??[],errors:J,description:"success"===me?c.jsxs("div",{className:"flex flex-col text-sm mt-2",children:[c.jsx("span",{children:"Tersedia pada"}),c.jsx("ul",{children:(le??[]).map(((e,a)=>c.jsxs("li",{className:"ml-2",children:["âœ“ ",e]},a)))})]}):c.jsx(c.Fragment,{}),isLoading:"pending"===L})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{disabled:!oe,label:"Jam Mulai Pinjam",type:"time",step:C,name:"start_borrowing_time",register:M("start_borrowing_time",{required:"Jam mulai pinjam harus diisi"}),setValue:F,errors:J,isLoading:"pending"===K&&!!B})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{disabled:!oe,label:"Jam Mulai Acara",type:"time",step:C,name:"start_event_time",register:M("start_event_time",{required:"Jam mulai acara harus diisi",validate:e=>{const a=X("start_borrowing_time"),r=new Date(`2000-01-01T${a}`);if(k(new Date(`2000-01-01T${e}`),r))return"Jam mulai harus setelah jam mulai pinjam"}}),setValue:F,errors:J,isLoading:"pending"===K&&!!B})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(b,{disabled:!oe,label:"Jam Selesai Pinjam",type:"time",step:C,name:"end_event_time",register:M("end_event_time",{required:"Jam akhir harus diisi",validate:e=>{const a=X("start_event_time"),r=new Date(`2000-01-01T${a}`);if(!v(new Date(`2000-01-01T${e}`),r))return"Jam akhir event harus setelah jam mulai event"}}),setValue:F,errors:J,isLoading:"pending"===K&&!!B})}),c.jsx("div",{className:"col-span-6 sm:col-span-4",children:"pending"===L?c.jsx(O,{}):Z&&S&&(null==(E=null==(e=S.find((e=>e.id===Z)))?void 0:e.room_items)?void 0:E.map(((e,a)=>{const r=z(`items.${a}.item_id`);return c.jsxs("div",{className:"grid grid-cols-3 items-center",children:[c.jsx(x,{disabled:!oe,label:e.item.name,name:`items.${a}.item_id`,id:`items.${a}.item_id`,value:e.item_id,register:M(`items.${a}.item_id`),inputContainerClassName:"col-span-2",errors:J}),!!r&&c.jsx(b,{type:"number",disabled:!oe,inputClassName:"input-sm",placeholder:"Jumlah barang",min:1,name:`items.${a}.quantity`,id:`items.${a}.quantity`,register:M(`items.${a}.quantity`,{required:"Harus diisi"}),setValue:F,errors:J})]},e.id)})))}),c.jsx("div",{className:"col-span-6",children:c.jsx(h,{disabled:!oe,label:"Keterangan",name:"description",id:"description",register:M("description",{required:"Keterangan harus diisi"}),setValue:F,errors:J})}),["UPDATE","CREATE","CONFIRMED"].includes(ne)&&c.jsxs("div",{className:"col-span-6 modal-action flex-row-reverse justify-between",children:[c.jsxs("div",{className:"flex flex-row gap-4",children:[c.jsx("button",{className:"btn btn-neutral",type:"button",children:"Tutup"}),["UPDATE","CREATE"].includes(ne)&&c.jsx("button",{className:"btn btn-primary",type:"submit",children:P?"Ubah":"Buat"})]}),P&&c.jsx("button",{className:"btn !ml-0 btn-error",type:"button",onClick:()=>ie(!0),children:"Hapus"})]}),de&&c.jsxs("div",{className:"col-span-6 modal-action flex-row-reverse justify-between",children:[c.jsx("button",{className:"btn btn-primary",onClick:G((async()=>await H())),children:"Setujui"}),c.jsx("button",{className:"btn !ml-0 btn-error",type:"button",onClick:async()=>{await W()},children:"Tolak"})]})]})]}),c.jsxs("dialog",{id:"delete_modal",className:"modal "+(se?"modal-open":""),children:[c.jsxs("div",{className:"modal-box",children:[c.jsx("h3",{className:"font-bold text-lg",children:"Konfirmasi Hapus"}),c.jsx("p",{className:"py-4",children:"Apakah Anda yakin ingin menghapus proposal pinjam ruang ini? Tindakan ini tidak dapat dibatalkan."}),c.jsxs("div",{className:"modal-action",children:[c.jsx("button",{className:"btn btn-neutral",onClick:()=>ie(!1),children:"Batal"}),c.jsx("button",{className:"btn btn-error",onClick:()=>{U(),ie(!1)},children:"Hapus"})]})]}),c.jsx("form",{method:"dialog",className:"modal-backdrop",children:c.jsx("button",{onClick:()=>ie(!1),children:"close"})})]})]})},O=()=>c.jsxs("div",{className:"flex flex-row gap-4 px-1 items-center",children:[c.jsx("div",{className:"bg-base-300 min-w-12 animate-pulse rounded-full h-7"}),c.jsx("div",{className:"bg-base-300 min-w-32 animate-pulse rounded-full h-6"})]});export{K as default};
