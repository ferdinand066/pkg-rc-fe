import{B as e,c as a,f as r,h as t,m as s,r as i,Q as n,i as o,k as l,w as d,a as m,j as c,P as u,t as p}from"./index-CI2_iiYJ.js";import{I as g}from"./InputSelect-CT8BYT1E.js";import{u as f,I as h}from"./InputText-CUIDzXwA.js";import{I as b}from"./InputTextarea-oiFeHUAY.js";import{I as w}from"./InputToggle-UtOu2VVr.js";import{A as x}from"./AlertContainer-BJPOcdJU.js";import{B as j,a as _}from"./use-borrowed-room-2F69xD2E.js";import{u as y,a as N}from"./use-room-wVUv2cGF.js";import{A as v,B as D}from"./constants-qRkPKk_L.js";import{s as T,b as q,c as C}from"./startOfDay-Cqt31xqJ.js";import{t as $}from"./isValid-5aXsojdQ.js";import"./useQuery-CPfaIPLg.js";function B(e,a){const r=$(e),t=$(a);return r.getTime()>t.getTime()}function R(e,a){const r=function(e){const a={},r=e.split(I.dateTimeDelimiter);let t;if(r.length>2)return a;/:/.test(r[0])?t=r[0]:(a.date=r[0],t=r[1],I.timeZoneDelimiter.test(a.date)&&(a.date=e.split(I.timeZoneDelimiter)[0],t=e.substr(a.date.length,e.length)));if(t){const e=I.timezone.exec(t);e?(a.time=t.replace(e[1],""),a.timezone=e[1]):a.time=t}return a}(e);let t;if(r.date){const e=function(e,a){const r=new RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+a)+"})|(\\d{2}|[+-]\\d{"+(2+a)+"})$)"),t=e.match(r);if(!t)return{year:NaN,restDateString:""};const s=t[1]?parseInt(t[1]):null,i=t[2]?parseInt(t[2]):null;return{year:null===i?s:100*i,restDateString:e.slice((t[1]||t[2]).length)}}(r.date,2);t=function(e,a){if(null===a)return new Date(NaN);const r=e.match(S);if(!r)return new Date(NaN);const t=!!r[4],s=K(r[1]),i=K(r[2])-1,n=K(r[3]),o=K(r[4]),l=K(r[5])-1;if(t)return function(e,a,r){return a>=1&&a<=53&&r>=0&&r<=6}(0,o,l)?function(e,a,r){const t=new Date(0);t.setUTCFullYear(e,0,4);const s=t.getUTCDay()||7,i=7*(a-1)+r+1-s;return t.setUTCDate(t.getUTCDate()+i),t}(a,o,l):new Date(NaN);{const e=new Date(0);return function(e,a,r){return a>=0&&a<=11&&r>=1&&r<=(P[a]||(J(e)?29:28))}(a,i,n)&&function(e,a){return a>=1&&a<=(J(e)?366:365)}(a,s)?(e.setUTCFullYear(a,i,Math.max(s,n)),e):new Date(NaN)}}(e.restDateString,e.year)}if(!t||isNaN(t.getTime()))return new Date(NaN);const s=t.getTime();let i,n=0;if(r.time&&(n=function(e){const a=e.match(V);if(!a)return NaN;const r=U(a[1]),t=U(a[2]),s=U(a[3]);if(!function(e,a,r){if(24===e)return 0===a&&0===r;return r>=0&&r<60&&a>=0&&a<60&&e>=0&&e<25}(r,t,s))return NaN;return r*q+t*C+1e3*s}(r.time),isNaN(n)))return new Date(NaN);if(!r.timezone){const e=new Date(s+n),a=new Date(0);return a.setFullYear(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()),a.setHours(e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds()),a}return i=function(e){if("Z"===e)return 0;const a=e.match(k);if(!a)return 0;const r="+"===a[1]?-1:1,t=parseInt(a[2]),s=a[3]&&parseInt(a[3])||0;if(!function(e,a){return a>=0&&a<=59}(0,s))return NaN;return r*(t*q+s*C)}(r.timezone),isNaN(i)?new Date(NaN):new Date(s+n+i)}const I={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},S=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,V=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,k=/^([+-])(\d{2})(?::?(\d{2}))?$/;function K(e){return e?parseInt(e):1}function U(e){return e&&parseFloat(e.replace(",","."))||0}const P=[31,null,31,30,31,30,31,31,30,31,30,31];function J(e){return e%400==0||e%4==0&&e%100!=0}const L="https://booking-api.reginacaeli.id/admin/borrowed-room";class M extends e{static async acceptBorrowedRoom(e,a){if(e)try{return await this._post(`${L}/${e}/accept`,a)}catch(r){throw new Error(r.message)}}static async declineBorrowedRoom(e){if(e)try{return await this._post(`${L}/${e}/decline`,{})}catch(a){throw new Error(a.message)}}}const Q=[{text:"menolak",style:"text-error"},{text:"menyetujui",style:"text-success"}],F=["badge-error","badge-warning","badge-success"],A=e=>{var a;if(!e)return[];const r=((null==e?void 0:e.borrowed_room_agreements)??[]).map((e=>({message:c.jsxs("span",{children:[e.created_by.name," telah"," ",c.jsx("span",{className:Q[e.agreement_status].style,children:Q[e.agreement_status].text})," ","permintaan ini."]})})));if(0===(e.pending_users??[]).length)return r;const t={message:c.jsxs("span",{children:[c.jsx("span",{className:"text-warning",children:"Menunggu konfirmasi"})," dari"," ",null==(a=e.pending_users)?void 0:a.map((e=>e.name)).join(", ")]})};return[...r,t]},E=()=>{var e,q;const{id:C}=d(),{data:I,status:S}=_(C??""),{data:V,status:k}=y({},!1),{register:K,setValue:U,errors:P,handleManageBorrowedRoom:J,handleDeleteBorrowedRoom:L,handleAcceptBorrowedRoom:Q,handleDeclineBorrowedRoom:E,handleSubmit:Z,watch:z,getValues:H,formState:Y}=((e=null)=>{const{register:d,setValue:m,getValues:c,formState:{errors:u},handleSubmit:p,watch:g,reset:h,formState:b}=f(),[w,x]=a(r),_=t(),N=s(),{data:v}=y({},!1);return i.useEffect((()=>{var a;if(h(),e){if(Object.keys(e).filter((e=>!["room_items","item_id"].includes(e))).forEach((a=>{m(a,e[a])})),!v)return;null==(a=e.borrowed_room_items)||a.map((e=>{var a;const r=g("room_id"),t=v.find((e=>e.id===r)),s=((null==(a=null==t?void 0:t.room_items)?void 0:a.map((e=>e.item_id)))??[]).indexOf(e.item_id);void 0!==s&&(s<0||(m(`items.${s}.item_id`,e.item_id),m(`items.${s}.quantity`,e.quantity)))}))}}),[e,m,v]),{register:d,setValue:m,errors:u,handleManageBorrowedRoom:async function(a){if(!w){a={...a,items:a.items.filter((e=>!!e.item_id))},x(!0);try{e?await n.promise(j.updateBorrowedRoom(e.id,a),{pending:"Waiting for update borrowed room!",error:o(),success:l()}):await n.promise(j.createBorrowedRoom(a),{pending:"Waiting for create borrowed room!",error:o(),success:l()})}catch(r){}_.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&_.invalidateQueries({queryKey:["general/borrowed-room",e.id]}),x(!1)}},handleDeleteBorrowedRoom:async function(){if(e&&!w){x(!0);try{await n.promise(j.deleteBorrowedRoom(e.id),{pending:"Waiting for delete borrowed room!",error:o(),success:l()})}catch(a){}x(!1),h(),_.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&_.invalidateQueries({queryKey:["general/borrowed-room",e.id]}),N("/room-request")}},handleAcceptBorrowedRoom:async function(){if(!e)return;if(w)return;const a=c("start_borrowing_time");x(!0);try{await n.promise(M.acceptBorrowedRoom(e.id,{start_borrowing_time:a}),{pending:"Waiting for accept borrowed room!",error:o(),success:l()})}catch(r){}x(!1),_.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e?_.invalidateQueries({queryKey:["general/borrowed-room",e.id]}):N("/room-request")},handleDeclineBorrowedRoom:async function(){if(e&&!w){x(!0);try{await n.promise(M.declineBorrowedRoom(e.id),{pending:"Waiting for decline borrowed room!",error:o(),success:l()})}catch(a){}x(!1),_.invalidateQueries({queryKey:["general/borrowed-room"]}),null!==e&&_.invalidateQueries({queryKey:["general/borrowed-room",e.id]})}},handleSubmit:p,watch:g,getValues:c,formState:b}})(I),O=z("room_id"),G=z("borrowed_date"),[X,ee]=i.useState(!1),[ae,re]=i.useState(!1),{user:te}=m();i.useEffect((()=>{if("success"!==k)return;if(X)return;if(I)return;ee(!0);U("room_id",V[0].id)}),[X,k]),i.useEffect((()=>{C?I&&te&&(2===I.borrowed_status&&te.role!==v||I.borrowed_by_user_id!==te.id&&te.role!==v||re(!0)):re(!0)}),[te,I]);const{data:se,status:ie}=N(O,{borrowing_date:G,borrowed_room_id:C,check_schedule:ae&&Y.isDirty});return c.jsx("section",{className:"flex flex-col h-full flex-1 gap-4 mb-8 divide-y",children:c.jsxs("div",{className:"flex flex-col",children:[c.jsx(u,{pageName:(C?"":"Buat ")+"Proposal Pinjam Ruang",action:"pending"===S?c.jsx("span",{className:"loading loading-dots loading-xs"}):I&&null!==(null==I?void 0:I.borrowed_status)?c.jsx("div",{className:p("badge badge-outline px-4 py-3",F[null==I?void 0:I.borrowed_status]),children:D[null==I?void 0:I.borrowed_status]}):c.jsx(c.Fragment,{})}),c.jsx(x,{notification:A(I)}),c.jsxs("form",{onSubmit:Z(J),className:"grid grid-cols-6 gap-4 mx-6",children:[c.jsx("div",{className:"col-span-6 sm:col-span-5",children:c.jsx(h,{label:"Nama Kegiatan",type:"text",name:"event_name",placeholder:"Contoh: Acara Natal",disabled:!ae,register:K("event_name",{required:"Nama kegiatan harus diisi"}),setValue:U,errors:P,isLoading:"pending"===S})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(h,{label:"Nama PIC",type:"text",name:"pic_name",placeholder:"Tuliskan nama anda",disabled:!ae,register:K("pic_name",{required:"Nama PIC harus diisi"}),setValue:U,errors:P,isLoading:"pending"===S})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(h,{label:"No. Telp PIC",type:"text",name:"pic_phone_number",placeholder:"Format: 08.....",disabled:!ae,register:K("pic_phone_number",{required:"No. Telp PIC harus diisi"}),setValue:U,errors:P,isLoading:"pending"===S})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(h,{label:"Tanggal Pinjam Ruangan",type:"date",name:"borrowed_date",disabled:!ae,register:K("borrowed_date",{required:"Tanggal peminjaman harus diisi",validate:e=>{const a=R(e),r=new Date;return!(!B(a,r)&&(t=a,s=r,+T(t)!=+T(s)))||"Tanggal peminjaman harus setelah hari ini";var t,s}}),setValue:U,errors:P,isLoading:"pending"===S})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(h,{disabled:!ae,label:"Kapasitas",type:"number",name:"capacity",register:K("capacity",{required:"Kapasitas harus diisi"}),setValue:U,errors:P,isLoading:"pending"===S})}),c.jsx("div",{className:"col-span-6 sm:col-span-4",children:c.jsx(g,{disabled:!ae,label:"Ruangan",name:"room_id",register:K("room_id",{required:"Ruangan harus diisi"}),setValue:U,model:(V??[]).map((e=>({id:e.id,name:e.name+" ("+e.floor.name+")"})))??[],errors:P,description:"success"===ie?c.jsxs("div",{className:"flex flex-col text-sm mt-2",children:[c.jsx("span",{children:"Tersedia pada"}),c.jsx("ul",{children:(se??[]).map(((e,a)=>c.jsxs("li",{className:"ml-2",children:["âœ“ ",e]},a)))})]}):c.jsx(c.Fragment,{}),isLoading:"pending"===k})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(h,{disabled:2===(null==I?void 0:I.borrowed_status),label:"Jam Mulai Pinjam",type:"time",name:"start_borrowing_time",register:K("start_borrowing_time",{required:"Jam mulai pinjam harus diisi"}),setValue:U,errors:P,isLoading:"pending"===S})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(h,{disabled:!ae,label:"Jam Mulai Acara",type:"time",name:"start_event_time",register:K("start_event_time",{required:"Jam mulai acara harus diisi",validate:e=>{const a=H("start_borrowing_time"),r=new Date(`2000-01-01T${a}`),t=new Date(`2000-01-01T${e}`);if(s=r,+$(t)<+$(s))return"Jam mulai harus setelah jam mulai pinjam";var s}}),setValue:U,errors:P,isLoading:"pending"===S})}),c.jsx("div",{className:"col-span-6 sm:col-span-2",children:c.jsx(h,{disabled:!ae,label:"Jam Selesai Pinjam",type:"time",name:"end_event_time",register:K("end_event_time",{required:"Jam akhir harus diisi",validate:e=>{const a=H("start_event_time"),r=new Date(`2000-01-01T${a}`);if(!B(new Date(`2000-01-01T${e}`),r))return"Jam akhir event harus setelah jam mulai event"}}),setValue:U,errors:P,isLoading:"pending"===S})}),c.jsx("div",{className:"col-span-6 sm:col-span-4",children:"pending"===k?c.jsx(W,{}):O&&V&&(null==(q=null==(e=V.find((e=>e.id===O)))?void 0:e.room_items)?void 0:q.map(((e,a)=>{const r=z(`items.${a}.item_id`);return c.jsxs("div",{className:"grid grid-cols-3 items-center",children:[c.jsx(w,{disabled:!ae,label:e.item.name,name:`items.${a}.item_id`,id:`items.${a}.item_id`,value:e.item_id,register:K(`items.${a}.item_id`),inputContainerClassName:"col-span-2",errors:P}),!!r&&c.jsx(h,{type:"number",disabled:!ae,inputClassName:"input-sm",placeholder:"Jumlah barang",min:1,name:`items.${a}.quantity`,id:`items.${a}.quantity`,register:K(`items.${a}.quantity`,{required:"Harus diisi"}),errors:P})]},e.id)})))}),c.jsx("div",{className:"col-span-6",children:c.jsx(b,{disabled:!ae,label:"Keterangan",name:"description",id:"description",register:K("description",{required:"Keterangan harus diisi"}),setValue:U,errors:P})}),ae&&c.jsxs("div",{className:"col-span-6 modal-action flex-row-reverse justify-between",children:[c.jsxs("div",{className:"flex flex-row gap-4",children:[c.jsx("button",{className:"btn btn-neutral",type:"button",children:"Tutup"}),c.jsx("button",{className:"btn btn-primary",type:"submit",children:I?"Ubah":"Buat"})]}),I&&c.jsx("button",{className:"btn !ml-0 btn-error",type:"button",onClick:()=>L(),children:"Hapus"})]}),te&&te.role===v&&!ae&&I&&1===I.borrowed_status&&0===((null==I?void 0:I.borrowed_room_agreements)??[]).filter((e=>e.created_by_user_id===te.id)).length&&c.jsxs("div",{className:"col-span-6 modal-action flex-row-reverse justify-between",children:[c.jsx("button",{className:"btn btn-primary",onClick:Z((async()=>await Q())),children:"Setujui"}),c.jsx("button",{className:"btn !ml-0 btn-error",type:"button",onClick:async()=>{await E()},children:"Tolak"})]})]})]})})},W=()=>c.jsxs("div",{className:"flex flex-row gap-4 px-1 items-center",children:[c.jsx("div",{className:"bg-base-300 min-w-12 animate-pulse rounded-full h-7"}),c.jsx("div",{className:"bg-base-300 min-w-32 animate-pulse rounded-full h-6"})]});export{E as default};
